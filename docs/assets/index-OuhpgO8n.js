(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function e(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=e(i);fetch(i.href,a)}})();const E={APPENTOS_APP_KEY:"cut-the-land",ENV:"development",ADMOB_INTERSTITIAL_ID:"ca-app-pub-3940256099942544/1033173712"};let S=!1;async function L(){if(S){console.log("Bedrock already initialized");return}window.Bedrock||(console.warn("‚ö†Ô∏è Bedrock SDK not found. Initializing Mock SDK for development."),C());try{const{Bedrock:c}=window;await c.init({appKey:E.APPENTOS_APP_KEY,env:E.ENV}),console.log("‚úÖ Bedrock initialized successfully"),S=!0,_()}catch(c){console.error("‚ùå Bedrock initialization failed:",c),console.warn("Running in development mode with limited Bedrock features")}}let w=!1;async function M(){if(window.Bedrock)try{console.log("‚è≥ Loading Interstitial Ad (2.0)..."),await window.Bedrock.loadAppsInTossAdMob({adUnitId:E.ADMOB_INTERSTITIAL_ID,adType:"interstitial"}),w=!0,console.log("‚úÖ Interstitial Ad Loaded (2.0)")}catch(c){console.warn("‚ùå Failed to load Interstitial Ad:",c),w=!1}}function T(){return new Promise(c=>{if(!w){console.log("‚ö†Ô∏è Ad not loaded, skipping..."),M(),c();return}try{console.log("üì∫ Showing Interstitial Ad (2.0)..."),window.Bedrock.showAppsInTossAdMob().then(()=>{console.log("‚úÖ Ad shown successfully (2.0)"),w=!1,M(),c()}).catch(t=>{console.warn("‚ùå Failed to show Ad:",t),c()})}catch(t){console.warn("‚ùå Error calling showAd:",t),c()}})}function C(){window.Bedrock={init:()=>Promise.resolve(),exit:()=>{console.log("üõë [Mock] Bedrock.exit() called"),confirm("Ïï± Ï¢ÖÎ£å (Mock)")&&window.close()},loadAppsInTossAdMob:c=>(console.log("üì¶ [Mock] loadAppsInTossAdMob (2.0):",c),new Promise(t=>setTimeout(t,1e3))),showAppsInTossAdMob:()=>(console.log("üì∫ [Mock] showAppsInTossAdMob (2.0) called"),console.log("‚úÖ [Mock] Ad closed (auto-dismissed)"),Promise.resolve())},window.NavigationBar={setTitle:c=>console.log(`üè∑Ô∏è [Mock] NavigationBar.setTitle: ${c}`),setBackButton:c=>{console.log("‚¨ÖÔ∏è [Mock] NavigationBar.setBackButton:",c),window.mockPressBackButton=c.onPress,console.log("üí° ÌÖåÏä§Ìä∏ ÌåÅ: Í∞úÎ∞úÏûê ÎèÑÍµ¨ ÏΩòÏÜîÏóêÏÑú window.mockPressBackButton() ÏùÑ Ïã§ÌñâÌïòÏó¨ Îí§Î°úÍ∞ÄÍ∏∞ ÎèôÏûëÏùÑ ÌÖåÏä§Ìä∏ÌïòÏÑ∏Ïöî.")}}}function _(){try{const{NavigationBar:c}=window;if(!c)return;c.setTitle("Cut the Land"),c.setBackButton({visible:!0,onPress:k}),console.log("‚úÖ Navigation bar configured")}catch(c){console.warn("Navigation bar setup failed:",c)}}function k(){if(console.log("‚¨ÖÔ∏è Handle Back Button Pressed"),confirm("Í≤åÏûÑÏùÑ Ï¢ÖÎ£åÌïòÏãúÍ≤†ÏäµÎãàÍπå?"))try{window.Bedrock.exit()}catch(t){console.warn("Cannot exit:",t)}}const o={GAME_WIDTH:288,GAME_HEIGHT:624,GRID_SIZE:3,TILE_SIZE:48,COLORS:{TRAIL:"#FFC107"},PLAYER_SPEED:1,MONSTER_SPEED:.5,CELL_TYPE:{UNOWNED:0,OWNED:1,TRAIL:2,WALL:3},THEMES:{forest:{path:"assets/theme/forest",types:["grass","dirt","water"],ratios:[.6,.1,.3],tiles:{grass:["tiles_forest_grass1.png","tiles_forest_grass2.png"],dirt:["tiles_forest_dirt1.png","tiles_forest_dirt2.png"],water:["tiles_forest_water1.png","tiles_forest_water2.png"]},objects:Array.from({length:12},(c,t)=>`obj${String(t+1).padStart(2,"0")}.png`)},ice:{path:"assets/theme/ice",types:["ice","dirt","water"],ratios:[.6,.1,.3],tiles:{ice:["tiles_ice_ice1.png","tiles_ice_ice2.png"],dirt:["tiles_ice_dirt1.png","tiles_ice_dirt2.png"],water:["tiles_ice_water1.png","tiles_ice_water2.png"]},objects:Array.from({length:12},(c,t)=>`obj${String(t+1).padStart(2,"0")}.png`)},wind:{path:"assets/theme/wind",types:["dirt","grass","water"],ratios:[.85,.05,.1],tiles:{dirt:["tiles_wind_dirt1.png","tiles_wind_dirt2.png"],grass:["tiles_wind_grass1.png","tiles_wind_grass2.png"],water:["tiles_wind_water1.png","tiles_wind_water2.png"]},objects:Array.from({length:12},(c,t)=>`obj${String(t+1).padStart(2,"0")}.png`)},space:{path:"assets/theme/space",types:["void","wreck","dust"],ratios:[.8,.05,.15],tiles:{void:["tiles_space_void1.png","tiles_space_void2.png"],wreck:["tiles_space_wreck1.png","tiles_space_wreck2.png"],dust:["tiles_space_dust1.png","tiles_space_dust2.png"]},objects:Array.from({length:12},(c,t)=>`obj${String(t+1).padStart(2,"0")}.png`)},volcano:{path:"assets/theme/volcano",types:["dust","lava","ore"],ratios:[.5,.4,.1],tiles:{dust:["tiles_volcano_dust1.png","tiles_volcano_dust2.png"],lava:["tiles_volcano_lava1.png","tiles_volcano_lava2.png"],ore:["tiles_volcano_ore1.png","tiles_volcano_ore2.png"]},objects:Array.from({length:12},(c,t)=>`obj${String(t+1).padStart(2,"0")}.png`)}}};class P{constructor(){this.joystick={x:0,y:0,active:!1},this.keys={ArrowUp:!1,ArrowDown:!1,ArrowLeft:!1,ArrowRight:!1,w:!1,a:!1,s:!1,d:!1},this.startPos={x:0,y:0},this.currentPos={x:0,y:0},this.maxRadius=50,this.setupTouchEvents(),this.setupMouseEvents(),this.setupKeyboardEvents()}setupTouchEvents(){const t=document.getElementById("game-canvas");t&&(t.addEventListener("touchstart",e=>{e.preventDefault();const s=e.touches[0];this.startPos={x:s.clientX,y:s.clientY},this.joystick.active=!0,this.showJoystick(s.clientX,s.clientY)},{passive:!1}),t.addEventListener("touchmove",e=>{if(e.preventDefault(),!this.joystick.active)return;const s=e.touches[0];this.currentPos={x:s.clientX,y:s.clientY},this.handleJoystickMove(this.currentPos.x,this.currentPos.y)},{passive:!1}),t.addEventListener("touchend",e=>{e.preventDefault(),this.joystick={x:0,y:0,active:!1},this.hideJoystick()}))}setupMouseEvents(){const t=document.getElementById("game-canvas");if(!t)return;let e=!1;t.addEventListener("mousedown",s=>{s.preventDefault(),e=!0,this.startPos={x:s.clientX,y:s.clientY},this.joystick.active=!0,this.showJoystick(s.clientX,s.clientY)}),window.addEventListener("mousemove",s=>{e&&(s.preventDefault(),this.currentPos={x:s.clientX,y:s.clientY},this.handleJoystickMove(this.currentPos.x,this.currentPos.y))}),window.addEventListener("mouseup",s=>{e&&(s.preventDefault(),e=!1,this.joystick={x:0,y:0,active:!1},this.hideJoystick())})}setupKeyboardEvents(){window.addEventListener("keydown",t=>{this.keys.hasOwnProperty(t.key)&&(this.keys[t.key]=!0)}),window.addEventListener("keyup",t=>{this.keys.hasOwnProperty(t.key)&&(this.keys[t.key]=!1)})}handleJoystickMove(t,e){let s=t-this.startPos.x,i=e-this.startPos.y,a=Math.sqrt(s*s+i*i);if(a>this.maxRadius){const h=Math.atan2(i,s),d=t-Math.cos(h)*this.maxRadius,l=e-Math.sin(h)*this.maxRadius;this.startPos={x:d,y:l},this.showJoystick(d,l),s=t-this.startPos.x,i=e-this.startPos.y,a=this.maxRadius}const r=Math.atan2(i,s),n=Math.min(a,this.maxRadius);this.joystick.x=Math.cos(r)*(n/this.maxRadius),this.joystick.y=Math.sin(r)*(n/this.maxRadius),this.updateJoystickUI(n,r)}updateJoystickUI(t,e){const s=document.getElementById("joystick-knob");if(!s)return;const i=Math.cos(e)*t,a=Math.sin(e)*t;s.style.transform=`translate(calc(-50% + ${i}px), calc(-50% + ${a}px))`}showJoystick(t,e){const s=document.getElementById("joystick-container");s&&(s.style.left=t+"px",s.style.top=e+"px",s.style.display="block")}hideJoystick(){const t=document.getElementById("joystick-container"),e=document.getElementById("joystick-knob");t&&(t.style.display="none"),e&&(e.style.transform="translate(-50%, -50%)")}getVector(){if(this.joystick.active)return{x:this.joystick.x,y:this.joystick.y};let t=0,e=0;if((this.keys.ArrowLeft||this.keys.a)&&(t-=1),(this.keys.ArrowRight||this.keys.d)&&(t+=1),(this.keys.ArrowUp||this.keys.w)&&(e-=1),(this.keys.ArrowDown||this.keys.s)&&(e+=1),t!==0||e!==0){const s=Math.sqrt(t*t+e*e);t/=s,e/=s}return{x:t,y:e}}}class A{constructor(){this.images={},this.loaded=!1}async loadTheme(t){const e=o.THEMES[t];if(!e){console.error(`[AssetManager] Theme ${t} not found`);return}const s=[];for(const[i,a]of Object.entries(e.tiles))a.forEach(r=>{const n=r,h=`${e.path}/${r}`;s.push(this.loadImage(n,h))});e.objects.forEach(i=>{const a=i,r=`${e.path}/${i}`;s.push(this.loadImage(a,r))}),s.push(this.loadImage("player",`${e.path}/player_moving.png`,!0)),s.push(this.loadImage("monster",`${e.path}/monster.png`,!0)),s.push(this.loadImage("boss","assets/monster_boss.png",!0)),s.push(this.loadImage("bossSkill","assets/monster_boss_skill.png",!0)),await Promise.all(s),this.loaded=!0,console.log(`[AssetManager] Theme ${t} loaded`)}loadImage(t,e,s=!1){return new Promise((i,a)=>{const r=new Image;r.crossOrigin="anonymous",r.onload=()=>{s?this.images[t]=this.removeCheckerboard(r):this.images[t]=r,i(this.images[t])},r.onerror=n=>{console.error(`[AssetManager] Failed to load ${e}`,n),i(null)},r.src=e})}removeCheckerboard(t){const e=document.createElement("canvas");e.width=t.width,e.height=t.height;const s=e.getContext("2d");s.drawImage(t,0,0);const i=s.getImageData(0,0,e.width,e.height),a=i.data;for(let r=0;r<a.length;r+=4){const n=a[r],h=a[r+1],d=a[r+2],l=n>240&&h>240&&d>240,g=n>180&&n<200&&h>180&&h<200&&d>180&&d<200;(l||g)&&(a[r+3]=0)}return s.putImageData(i,0,0),e}getImage(t){return this.images[t]}}class b{constructor(t){this.canvas=t,this.ctx=t.getContext("2d"),this.assetManager=new A,this.terrainCanvas=document.createElement("canvas"),this.terrainCtx=this.terrainCanvas.getContext("2d"),this.terrainRendered=!1,this.fogCanvas=document.createElement("canvas"),this.fogCtx=this.fogCanvas.getContext("2d"),this.maskCanvas=document.createElement("canvas"),this.maskCtx=this.maskCanvas.getContext("2d"),this.commonImages={},this.processedCommonImages={},this.camera={x:0,y:0,width:0,height:0},this.zoomLevel=1.5,this.snowParticles=[],this.initSnow(),this.windParticles=[],this.initWind(),this.init()}init(){this.worldWidth=o.GAME_WIDTH,this.worldHeight=o.GAME_HEIGHT,this.initAsync()}async initAsync(){try{this.resize(),window.addEventListener("resize",()=>this.resize())}catch(t){console.error("[Renderer] Init failed:",t)}}setWorldSize(t,e){this.worldWidth=t,this.worldHeight=e,this.resize()}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.canvas.style.width="100%",this.canvas.style.height="100%",this.camera.width=this.canvas.width/this.zoomLevel,this.camera.height=this.canvas.height/this.zoomLevel,this.ctx.imageSmoothingEnabled=!1,this.ctx.webkitImageSmoothingEnabled=!1,this.ctx.mozImageSmoothingEnabled=!1,this.ctx.msImageSmoothingEnabled=!1,this.terrainCanvas.width=this.worldWidth,this.terrainCanvas.height=this.worldHeight,this.terrainCtx.imageSmoothingEnabled=!1,this.terrainCtx.webkitImageSmoothingEnabled=!1,this.terrainCtx.mozImageSmoothingEnabled=!1,this.terrainCtx.msImageSmoothingEnabled=!1,this.fogCanvas.width=this.worldWidth,this.fogCanvas.height=this.worldHeight,this.fogCtx.imageSmoothingEnabled=!1,this.fogCtx.webkitImageSmoothingEnabled=!1,this.fogCtx.mozImageSmoothingEnabled=!1,this.fogCtx.msImageSmoothingEnabled=!1,this.maskCanvas.width=this.worldWidth,this.maskCanvas.height=this.worldHeight,this.maskCtx.imageSmoothingEnabled=!1,this.maskCtx.webkitImageSmoothingEnabled=!1,this.maskCtx.mozImageSmoothingEnabled=!1,this.maskCtx.msImageSmoothingEnabled=!1,this.assetManager.loaded&&(this.terrainRendered=!1)}updateCamera(t){this.camera.x=t.x-this.camera.width/2,this.camera.y=t.y-this.camera.height/2,this.worldWidth<this.camera.width?this.camera.x=-(this.camera.width-this.worldWidth)/2:this.camera.x=Math.max(0,Math.min(this.camera.x,this.worldWidth-this.camera.width)),this.worldHeight<this.camera.height?this.camera.y=-(this.camera.height-this.worldHeight)/2:this.camera.y=Math.max(0,Math.min(this.camera.y,this.worldHeight-this.camera.height))}clear(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}render(t,e,s,i,a,r){this.clear(),this.updateCamera(e),this.ctx.save(),this.ctx.scale(this.zoomLevel,this.zoomLevel),this.ctx.translate(-this.camera.x,-this.camera.y),this.drawMap(t,i),this.drawPlayer(e),this.drawMonsters(s),t.boss&&this.drawBoss(t.boss),i==="wind"&&a&&this.drawWindIndicator(e,a),this.ctx.restore(),i==="ice"?(this.updateSnow(),this.drawSnow()):i==="wind"&&a&&(this.updateWind(a),this.drawWind(a)),r&&r.type==="dark_fog"&&r.active&&this.drawDarkFog(e)}renderTerrainLayer(t){if(!this.assetManager.loaded||!t.tileMap||t.tileMap.length===0)return;this.terrainCtx.clearRect(0,0,this.terrainCanvas.width,this.terrainCanvas.height);const e=o.TILE_SIZE;for(let s=0;s<t.tileRows;s++)for(let i=0;i<t.tileCols;i++){const a=t.tileMap[s][i];if(a){const r=this.assetManager.getImage(a);r&&r.complete&&this.terrainCtx.drawImage(r,i*e,s*e,e,e)}}for(const s of t.objects){const i=this.assetManager.getImage(s.image);i&&i.complete&&this.terrainCtx.drawImage(i,s.x,s.y)}this.terrainRendered=!0}drawMap(t,e){this.assetManager.loaded&&!this.terrainRendered&&this.renderTerrainLayer(t),this.ctx.drawImage(this.terrainCanvas,0,0),this.maskCtx.clearRect(0,0,this.maskCanvas.width,this.maskCanvas.height),this.maskCtx.fillStyle="#FFF";const s=o.GRID_SIZE,i=t.grid;for(let a=0;a<t.rows;a++)for(let r=0;r<t.cols;r++)i[a][r]===o.CELL_TYPE.OWNED&&this.maskCtx.fillRect(r*s,a*s,s,s);this.fogCtx.clearRect(0,0,this.fogCanvas.width,this.fogCanvas.height),this.fogCtx.globalCompositeOperation="source-over",e==="space"?this.fogCtx.fillStyle="rgba(255, 255, 255, 0.8)":this.fogCtx.fillStyle="rgba(0, 0, 0, 0.8)",this.fogCtx.fillRect(0,0,this.fogCanvas.width,this.fogCanvas.height),this.fogCtx.globalCompositeOperation="destination-out",this.fogCtx.shadowBlur=20,this.fogCtx.shadowColor="#000",this.fogCtx.drawImage(this.maskCanvas,0,0),this.fogCtx.shadowBlur=0,this.fogCtx.shadowColor="transparent",this.ctx.drawImage(this.fogCanvas,0,0),this.ctx.fillStyle=o.COLORS.TRAIL;for(let a=0;a<t.rows;a++)for(let r=0;r<t.cols;r++)i[a][r]===o.CELL_TYPE.TRAIL&&this.ctx.fillRect(r*s,a*s,s,s)}drawPlayer(t){const e=this.assetManager.getImage("player"),s=t.scale||1;if(e){const i=24*s,a=48;this.ctx.drawImage(e,t.currentFrame*a,0,a,a,t.x-i/2,t.y-i/2,i,i)}else this.ctx.fillStyle="#2196F3",this.ctx.beginPath(),this.ctx.arc(t.x,t.y,t.radius,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle="#FFF",this.ctx.lineWidth=2,this.ctx.stroke()}drawMonsters(t){const e=this.assetManager.getImage("monster");for(const s of t){const i=s.scale||1;if(e){const a=24*i,r=48;this.ctx.drawImage(e,s.currentFrame*r,0,r,r,s.x-a/2,s.y-a/2,a,a)}else this.ctx.fillStyle="#F44336",this.ctx.beginPath(),this.ctx.arc(s.x,s.y,s.radius,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle="#FFF",this.ctx.lineWidth=2,this.ctx.stroke()}}drawBoss(t){if(!t)return;if(t.state==="CASTING"&&t.targetArea){const{x:s,y:i,radius:a}=t.targetArea;this.ctx.fillStyle="rgba(244, 67, 54, 0.3)",this.ctx.beginPath(),this.ctx.arc(s,i,a,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle="rgba(244, 67, 54, 0.8)",this.ctx.lineWidth=2,this.ctx.stroke();const r=t.castTimer%1e3/1e3,n=a*(1-r);this.ctx.fillStyle="rgba(244, 67, 54, 0.5)",this.ctx.beginPath(),this.ctx.arc(s,i,n,0,Math.PI*2),this.ctx.fill()}let e=this.assetManager.getImage("boss");if(t.state==="CASTING"){const s=this.assetManager.getImage("bossSkill");s&&(e=s)}e?this.ctx.drawImage(e,t.currentFrame*48,0,48,48,t.x-40/2,t.y-40/2,40,40):(this.ctx.fillStyle="#9C27B0",this.ctx.beginPath(),this.ctx.arc(t.x,t.y,t.radius,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle="#FFF",this.ctx.lineWidth=3,this.ctx.stroke())}initSnow(){this.snowParticles=Array.from({length:100},()=>({x:Math.random()*window.innerWidth,y:Math.random()*window.innerHeight,radius:Math.random()*2+1,speed:Math.random()*1+.5,opacity:Math.random()*.5+.3}))}updateSnow(){for(const t of this.snowParticles)t.y+=t.speed,t.y>window.innerHeight&&(t.y=-5,t.x=Math.random()*window.innerWidth)}drawSnow(){this.ctx.fillStyle="#FFF";for(const t of this.snowParticles)this.ctx.globalAlpha=t.opacity,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,t.radius,0,Math.PI*2),this.ctx.fill();this.ctx.globalAlpha=1}initWind(){this.windParticles=Array.from({length:50},()=>({x:Math.random()*window.innerWidth,y:Math.random()*window.innerHeight,length:Math.random()*20+10,speed:Math.random()*2+2,opacity:Math.random()*.3+.1}))}updateWind(t){for(const e of this.windParticles)e.x+=t.direction.x*e.speed,e.y+=t.direction.y*e.speed,e.x<-50&&(e.x=window.innerWidth+50),e.x>window.innerWidth+50&&(e.x=-50),e.y<-50&&(e.y=window.innerHeight+50),e.y>window.innerHeight+50&&(e.y=-50)}drawWind(t){this.ctx.strokeStyle="rgba(255, 255, 255, 0.5)",this.ctx.lineWidth=1;for(const e of this.windParticles)this.ctx.globalAlpha=e.opacity,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(e.x-t.direction.x*e.length,e.y-t.direction.y*e.length),this.ctx.stroke();this.ctx.globalAlpha=1}drawWindIndicator(t,e){const s=t.x,i=t.y-60;this.ctx.save(),this.ctx.translate(s,i),this.ctx.fillStyle="#333",this.ctx.beginPath(),this.ctx.arc(0,0,3,0,Math.PI*2),this.ctx.fill(),this.ctx.rotate(e.angle),this.ctx.strokeStyle="#D32F2F",this.ctx.lineWidth=2,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.beginPath(),this.ctx.moveTo(-15,0),this.ctx.lineTo(15,0),this.ctx.stroke(),this.ctx.fillStyle="#D32F2F",this.ctx.beginPath(),this.ctx.moveTo(18,0),this.ctx.lineTo(10,-6),this.ctx.lineTo(10,6),this.ctx.closePath(),this.ctx.fill(),this.ctx.beginPath(),this.ctx.moveTo(-15,0),this.ctx.lineTo(-22,-7),this.ctx.lineTo(-22,7),this.ctx.closePath(),this.ctx.fill(),this.ctx.restore()}drawDarkFog(t){this.ctx.save(),this.ctx.fillStyle="#000",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.globalCompositeOperation="destination-out";const e=(t.x-this.camera.x)*this.zoomLevel,s=(t.y-this.camera.y)*this.zoomLevel,i=100;this.ctx.beginPath(),this.ctx.arc(e,s,i,0,Math.PI*2),this.ctx.fill(),this.ctx.restore()}}class D{constructor(){this.grid=[],this.tileMap=[],this.objects=[],this.reset()}reset(t=1,e="forest"){this.width=Math.floor(o.GAME_WIDTH*t),this.height=Math.floor(o.GAME_HEIGHT*t),this.cols=Math.ceil(this.width/o.GRID_SIZE),this.rows=Math.ceil(this.height/o.GRID_SIZE),this.tileCols=Math.ceil(this.width/o.TILE_SIZE),this.tileRows=Math.ceil(this.height/o.TILE_SIZE),this.grid=Array(this.rows).fill().map(()=>Array(this.cols).fill(o.CELL_TYPE.UNOWNED));const s=Math.floor(this.cols/2),i=Math.floor(this.rows/2),a=8;for(let r=-a;r<=a;r++)for(let n=-a;n<=a;n++)if(n*n+r*r<=a*a){const h=s+n,d=i+r;this.isValid(h,d)&&(this.grid[d][h]=o.CELL_TYPE.OWNED)}this.generateTerrain(e)}generateTerrain(t){const e=o.THEMES[t];if(!e)return;this.tileMap=Array(this.tileRows).fill().map(()=>Array(this.tileCols).fill(null));let s=Array(this.tileRows).fill().map(()=>Array(this.tileCols).fill(0));const i=e.ratios[0],a=e.ratios[1];for(let d=0;d<this.tileRows;d++)for(let l=0;l<this.tileCols;l++){const g=Math.random();g<i?s[d][l]=0:g<i+a?s[d][l]=1:s[d][l]=2}const r=4;for(let d=0;d<r;d++){const l=s.map(g=>[...g]);for(let g=0;g<this.tileRows;g++)for(let m=0;m<this.tileCols;m++){const f={0:0,1:0,2:0};for(let u=-1;u<=1;u++)for(let y=-1;y<=1;y++){if(y===0&&u===0)continue;const x=g+u,p=m+y;x>=0&&x<this.tileRows&&p>=0&&p<this.tileCols?f[s[x][p]]++:f[s[g][m]]++}f[2]>4?l[g][m]=2:f[1]>4?l[g][m]=1:f[0]>4&&(l[g][m]=0)}s=l}const n=e.types;for(let d=0;d<this.tileRows;d++)for(let l=0;l<this.tileCols;l++){const g=s[d][l],m=n[g],f=e.tiles[m];f&&f.length>0?this.tileMap[d][l]=f[Math.floor(Math.random()*f.length)]:console.warn(`[MapSystem] Missing variants for theme ${t} type ${m}`)}this.objects=[];const h=(d,l,g,m)=>{if(s[l][d]===2)return!1;for(const f of this.objects)if(Math.hypot(f.x-g,f.y-m)<o.TILE_SIZE*.8)return!1;return!0};for(const d of e.objects){const l=Math.floor(Math.random()*3)+1;for(let g=0;g<l;g++){let m=0,f=!1;for(;m<20&&!f;){const u=Math.floor(Math.random()*this.tileCols),y=Math.floor(Math.random()*this.tileRows),x=Math.random()*(o.TILE_SIZE/2),p=Math.random()*(o.TILE_SIZE/2),I=u*o.TILE_SIZE+x,v=y*o.TILE_SIZE+p;h(u,y,I,v)&&(this.objects.push({x:I,y:v,image:d}),f=!0),m++}}}}getCell(t,e){const s=Math.floor(t/o.GRID_SIZE),i=Math.floor(e/o.GRID_SIZE);return s<0||s>=this.cols||i<0||i>=this.rows?null:this.grid[i][s]}setCell(t,e,s){const i=Math.floor(t/o.GRID_SIZE),a=Math.floor(e/o.GRID_SIZE);i>=0&&i<this.cols&&a>=0&&a<this.rows&&(this.grid[a][i]=s)}isValid(t,e){return t>=0&&t<this.cols&&e>=0&&e<this.rows}findEmptyAreas(){const t=Array(this.rows).fill().map(()=>Array(this.cols).fill(!1)),e=[];for(let s=0;s<this.rows;s++)for(let i=0;i<this.cols;i++)if(this.grid[s][i]===o.CELL_TYPE.UNOWNED&&!t[s][i]){const a=[],r=[{x:i,y:s}];t[s][i]=!0;let n=!1;for(;r.length>0;){const h=r.pop();a.push(h),(h.x===0||h.x===this.cols-1||h.y===0||h.y===this.rows-1)&&(n=!0);const d=[{x:h.x+1,y:h.y},{x:h.x-1,y:h.y},{x:h.x,y:h.y+1},{x:h.x,y:h.y-1}];for(const l of d)this.isValid(l.x,l.y)&&!t[l.y][l.x]&&this.grid[l.y][l.x]===o.CELL_TYPE.UNOWNED&&(t[l.y][l.x]=!0,r.push(l))}n?console.log(`  ‚ö†Ô∏è Skipping border area (${a.length} cells)`):e.push(a)}return e}fillAreas(t,e=[]){console.log("üéØ fillAreas called with currentTrail:",e);for(const a of e){const r=Math.floor(a.x/o.GRID_SIZE),n=Math.floor(a.y/o.GRID_SIZE);this.isValid(r,n)&&this.grid[n][r]===o.CELL_TYPE.TRAIL&&(this.grid[n][r]=o.CELL_TYPE.OWNED)}const s=this.findEmptyAreas();console.log(`  Found ${s.length} empty areas`);let i=0;if(s.length===0){for(let a=0;a<this.rows;a++)for(let r=0;r<this.cols;r++)this.grid[a][r]===o.CELL_TYPE.TRAIL&&(this.grid[a][r]=o.CELL_TYPE.OWNED);return 0}for(const a of s){console.log(`  Filling area (${a.length} cells)`);for(const r of a)this.grid[r.y][r.x]=o.CELL_TYPE.OWNED,i++}for(let a=0;a<this.rows;a++)for(let r=0;r<this.cols;r++)this.grid[a][r]===o.CELL_TYPE.TRAIL&&(this.grid[a][r]=o.CELL_TYPE.OWNED);return i}clearTrails(){for(let t=0;t<this.rows;t++)for(let e=0;e<this.cols;e++)this.grid[t][e]===o.CELL_TYPE.TRAIL&&(this.grid[t][e]=o.CELL_TYPE.UNOWNED)}getOwnedPercentage(){let t=0;const e=this.rows*this.cols;for(let s=0;s<this.rows;s++)for(let i=0;i<this.cols;i++)this.grid[s][i]===o.CELL_TYPE.OWNED&&t++;return t/e*100}}class R{constructor(){this.currentStage=1,this.stages=[{level:1,theme:"forest",mapSize:.8,monsters:[{count:2}]},{level:2,theme:"forest",mapSize:1,timeLimit:60,monsters:[{count:3}]},{level:3,theme:"ice",mapSize:1,timeLimit:90,effects:{type:"ice"},monsters:[{count:4}]},{level:4,theme:"wind",mapSize:1,timeLimit:90,effects:{type:"wind"},monsters:[{count:5}]},{level:5,theme:"volcano",mapSize:1.2,timeLimit:90,boss:!0,monsters:[{count:3}]},{level:6,theme:"ice",mapSize:1,timeLimit:100,scale:1.1,effects:{type:"ice"},monsters:[{count:5}]},{level:7,theme:"forest",mapSize:1,timeLimit:100,scale:1.1,effects:{type:"dark_fog"},monsters:[{count:5}]},{level:8,theme:"wind",mapSize:1,timeLimit:100,scale:1.1,effects:{type:"wind"},monsters:[{count:5}]},{level:9,theme:"space",mapSize:1,timeLimit:100,scale:1.1,effects:{type:"space_distortion"},monsters:[{count:5}]},{level:10,theme:"volcano",mapSize:1.2,timeLimit:100,scale:1.1,boss:!0,monsters:[{count:4}]}]}getStageData(t){return this.stages.find(e=>e.level===t)||this.stages[0]}}class B{constructor(t,e,s=1){this.x=t,this.y=e,this.vx=0,this.vy=0,this.radius=8*s,this.scale=s,this.speed=o.PLAYER_SPEED,this.isDrawing=!1,this.trail=[],this.animTimer=0,this.currentFrame=0,this.totalFrames=2,this.frameDuration=200}update(t,e,s,i,a){this.vx=t.x,this.vy=t.y;let r=this.speed;if(i&&i.type==="ice"&&(t.x===0&&t.y===0&&(this.y+=1*s/1e3),t.y<0?r*=.6:t.y>0&&(r*=1.4)),i&&i.type==="wind"&&a&&(t.x!==0||t.y!==0)){const m=1+(t.x*a.direction.x+t.y*a.direction.y)*.4;r*=m}if(i&&i.type==="dark_fog"&&i.active&&(r*=.4),i&&i.type==="space_distortion"&&(r*=.8),t.x===0&&t.y===0&&(!i||i.type!=="ice"))return"IDLE";const n=this.x+t.x*r,h=this.y+t.y*r;if(n<0||n>e.width||h<0||h>e.height)return"BLOCKED";const d=e.getCell(this.x,this.y),l=e.getCell(n,h);if(d===o.CELL_TYPE.OWNED&&l===o.CELL_TYPE.UNOWNED&&(this.isDrawing=!0),this.isDrawing){if(l===o.CELL_TYPE.OWNED)return this.isDrawing=!1,this.x=n,this.y=h,this.lastTrail=[...this.trail],console.log("‚úÖ Player FILL - lastTrail saved:",this.lastTrail.length,"points"),this.trail=[],"FILL";l===o.CELL_TYPE.UNOWNED&&(e.setCell(n,h,o.CELL_TYPE.TRAIL),this.trail.push({x:n,y:h}))}return this.x=n,this.y=h,this.animTimer+=s,this.animTimer>=this.frameDuration&&(this.animTimer=0,this.currentFrame=(this.currentFrame+1)%this.totalFrames),"MOVE"}teleport(t){let e=!1,s=0,i,a;for(;!e&&s<10;)i=Math.random()*t.width,a=Math.random()*t.height,t.getCell(i,a)!==o.CELL_TYPE.WALL&&(e=!0),s++;e&&(this.x=i,this.y=a,this.isDrawing=!1,this.trail=[])}}class O{constructor(t,e,s=1){this.x=t,this.y=e,this.radius=8*s,this.scale=s,this.speed=o.MONSTER_SPEED;const i=Math.random()*Math.PI*2;this.vx=Math.cos(i)*this.speed,this.vy=Math.sin(i)*this.speed,this.changeDirTimer=0,this.animTimer=0,this.currentFrame=0,this.totalFrames=2,this.frameDuration=200}update(t){if(this.changeDirTimer++,this.changeDirTimer>60){this.changeDirTimer=0;const i=Math.random()*Math.PI*2;this.vx=Math.cos(i)*this.speed,this.vy=Math.sin(i)*this.speed}let e=this.x+this.vx,s=this.y+this.vy;if((e<0||e>t.width)&&(this.vx*=-1,e=Math.max(0,Math.min(t.width,e))),(s<0||s>t.height)&&(this.vy*=-1,s=Math.max(0,Math.min(t.height,s))),t.getCell(e,s)===o.CELL_TYPE.OWNED){this.vx*=-1,this.vy*=-1;const i=Math.random()*Math.PI*2;this.vx=Math.cos(i)*this.speed,this.vy=Math.sin(i)*this.speed}else this.x=e,this.y=s;this.animTimer+=16,this.animTimer>=this.frameDuration&&(this.animTimer=0,this.currentFrame=(this.currentFrame+1)%this.totalFrames)}checkCollision(t,e){const s=this.x-t.x,i=this.y-t.y;return Math.sqrt(s*s+i*i)<this.radius+t.radius?(console.log("Monster collision: Direct hit!"),!0):e.getCell(this.x,this.y)===o.CELL_TYPE.TRAIL?(console.log("Monster collision: Trail hit!"),!0):!1}}class F{constructor(t,e){this.x=t,this.y=e,this.radius=24,this.speed=80,this.angle=Math.random()*Math.PI*2,this.state="MOVING",this.skillTimer=0,this.skillInterval=1e4,this.castDuration=3e3,this.castTimer=0,this.targetArea=null,this.animTimer=0,this.currentFrame=0,this.totalFrames=2,this.frameDuration=200}update(t,e,s){this.state==="MOVING"?(this.updateMovement(t,e),this.skillTimer+=e,this.skillTimer>=this.skillInterval&&this.startCasting(t)):this.state==="CASTING"&&(this.castTimer+=e,this.castTimer>=this.castDuration&&this.fireSkill(t,s)),this.animTimer+=e,this.animTimer>=this.frameDuration&&(this.animTimer=0,this.currentFrame=(this.currentFrame+1)%this.totalFrames)}updateMovement(t,e){this.x+=Math.cos(this.angle)*this.speed*(e/1e3),this.y+=Math.sin(this.angle)*this.speed*(e/1e3);let s=!1;this.x<this.radius&&(this.x=this.radius,this.angle=Math.PI-this.angle,s=!0),this.x>t.width-this.radius&&(this.x=t.width-this.radius,this.angle=Math.PI-this.angle,s=!0),this.y<this.radius&&(this.y=this.radius,this.angle=-this.angle,s=!0),this.y>t.height-this.radius&&(this.y=t.height-this.radius,this.angle=-this.angle,s=!0),!s&&Math.random()<.02&&(this.angle+=(Math.random()-.5)*Math.PI)}startCasting(t){this.state="CASTING",this.castTimer=0,this.skillTimer=0;const s=t.width*t.height*.05,i=Math.sqrt(s/Math.PI),a=i,r=a+Math.random()*(t.width-a*2),n=a+Math.random()*(t.height-a*2);this.targetArea={x:r,y:n,radius:i}}fireSkill(t,e){const s=e.x-this.targetArea.x,i=e.y-this.targetArea.y;Math.sqrt(s*s+i*i)<this.targetArea.radius+e.radius?this.lastSkillResult="KILL":this.lastSkillResult="MISS";const r=Math.max(0,Math.floor((this.targetArea.x-this.targetArea.radius)/o.GRID_SIZE)),n=Math.min(t.cols-1,Math.ceil((this.targetArea.x+this.targetArea.radius)/o.GRID_SIZE)),h=Math.max(0,Math.floor((this.targetArea.y-this.targetArea.radius)/o.GRID_SIZE)),d=Math.min(t.rows-1,Math.ceil((this.targetArea.y+this.targetArea.radius)/o.GRID_SIZE));for(let l=h;l<=d;l++)for(let g=r;g<=n;g++){const m=g*o.GRID_SIZE+o.GRID_SIZE/2,f=l*o.GRID_SIZE+o.GRID_SIZE/2,u=m-this.targetArea.x,y=f-this.targetArea.y;u*u+y*y<this.targetArea.radius*this.targetArea.radius&&t.grid[l][g]===o.CELL_TYPE.OWNED&&(t.grid[l][g]=o.CELL_TYPE.UNOWNED)}this.state="MOVING",this.targetArea=null}checkCollision(t,e){const s=this.x-t.x,i=this.y-t.y;if(Math.sqrt(s*s+i*i)<this.radius+t.radius)return!0;const r=Math.floor(this.x/o.GRID_SIZE),n=Math.floor(this.y/o.GRID_SIZE);return r>=0&&r<e.cols&&n>=0&&n<e.rows&&e.grid[n][r]===o.CELL_TYPE.TRAIL}}class W{constructor(){this.canvas=document.getElementById("game-canvas"),this.renderer=new b(this.canvas),this.input=new P,this.mapSystem=new D,this.stageManager=new R,this.currentLevel=1,this.isTransitioning=!1,this.uiAreaScore=document.getElementById("area-score"),this.uiMonsterCount=document.getElementById("monster-count"),this.uiStageLevel=document.getElementById("stage-level"),this.uiTransition=document.getElementById("stage-transition"),this.uiGameOver=document.getElementById("game-over-popup"),this.startStage(this.currentLevel),this.lastTime=0,this.isRunning=!0,this.isPaused=!1,this.loop=this.loop.bind(this),requestAnimationFrame(this.loop),this.setupControls(),M()}setupControls(){document.getElementById("pause-btn").addEventListener("click",()=>this.togglePause()),document.getElementById("restart-btn").addEventListener("click",()=>{this.uiGameOver.style.display="none",this.startStage(this.currentLevel)}),document.getElementById("continue-btn").addEventListener("click",async()=>{await T(),this.revivePlayer()})}async startStage(t){const e=this.stageManager.getStageData(t);this.currentLevel=t,this.uiStageLevel.textContent=t,this.currentStageEffects=e.effects||{},document.getElementById("loading-screen").style.display="flex",await this.renderer.assetManager.loadTheme(e.theme),document.getElementById("loading-screen").style.display="none",this.currentStageEffects.type==="wind"?(this.windData={direction:{x:1,y:0},angle:0,timer:0,changeInterval:1e4},this.updateWindDirection()):this.windData=null,this.currentStageEffects.type==="dark_fog"&&(this.currentStageEffects.active=!1,this.currentStageEffects.timer=0,this.currentStageEffects.nextTrigger=Math.random()*1e4+15e3,this.currentStageEffects.duration=3e3),this.currentStageEffects.type==="space_distortion"&&(this.currentStageEffects.teleportTimer=0,this.currentStageEffects.nextTeleport=Math.random()*5e3+15e3),this.timeLimit=e.timeLimit,this.timeLeft=this.timeLimit;const s=document.getElementById("ui-timer");this.timeLimit?(s.style.display="block",s.textContent=this.formatTime(this.timeLeft),s.style.color="#fff"):s.style.display="none",this.mapSystem.reset(e.mapSize||1,e.theme),this.renderer.setWorldSize(this.mapSystem.width,this.mapSystem.height);const i=this.mapSystem.width/2,a=this.mapSystem.height/2,r=e.scale||1;if(this.player=new B(i,a,r),this.monsters=[],e&&e.monsters&&e.monsters.forEach(n=>{for(let h=0;h<n.count;h++){let d,l;do d=Math.random()*this.mapSystem.width,l=Math.random()*this.mapSystem.height;while(Math.hypot(d-i,l-a)<200);this.monsters.push(new O(d,l,r))}}),e.boss){let n,h;do n=Math.random()*this.mapSystem.width,h=Math.random()*this.mapSystem.height;while(Math.hypot(n-i,h-a)<300);this.mapSystem.boss=new F(n,h)}else this.mapSystem.boss=null;this.uiLayer=document.getElementById("ui-layer"),this.uiLayer.style.display="flex",this.isTransitioning=!1,this.uiTransition.style.display="none",this.isRunning=!0,this.lastTime=performance.now()}togglePause(){this.isPaused=!this.isPaused;const t=document.getElementById("pause-btn");this.isPaused?t.innerHTML=`
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M8 5V19L19 12L8 5Z" fill="currentColor"/>
                </svg>
            `:(t.innerHTML=`
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 4H10V20H6V4ZM14 4H18V20H14V4Z" fill="currentColor"/>
                </svg>
            `,this.lastTime=performance.now())}update(t){if(!this.isRunning||this.isPaused||this.isTransitioning||!this.player)return;if(this.windData&&(this.windData.timer+=t,this.windData.timer>=this.windData.changeInterval&&(this.windData.timer=0,this.updateWindDirection())),this.currentStageEffects&&this.currentStageEffects.type==="dark_fog"&&(this.currentStageEffects.timer+=t,this.currentStageEffects.active?this.currentStageEffects.timer>=this.currentStageEffects.duration&&(this.currentStageEffects.active=!1,this.currentStageEffects.timer=0,this.currentStageEffects.nextTrigger=Math.random()*1e4+15e3,console.log("Dark Fog ended")):this.currentStageEffects.timer>=this.currentStageEffects.nextTrigger&&(this.currentStageEffects.active=!0,this.currentStageEffects.timer=0,console.log("Dark Fog started"))),this.currentStageEffects&&this.currentStageEffects.type==="space_distortion"&&(this.currentStageEffects.teleportTimer+=t,this.currentStageEffects.teleportTimer>=this.currentStageEffects.nextTeleport&&(this.currentStageEffects.teleportTimer=0,this.currentStageEffects.nextTeleport=Math.random()*5e3+15e3,this.player.teleport(this.mapSystem),console.log("Player teleported"))),this.timeLimit&&this.timeLeft>0){this.timeLeft-=t/1e3,this.timeLeft<=0&&(this.timeLeft=0,this.gameOver());const a=document.getElementById("ui-timer"),r=Math.ceil(this.timeLeft);a.textContent=this.formatTime(r),r<=10?a.style.color="#F44336":r<=20?a.style.color="#FF9800":r<=30?a.style.color="#FFEB3B":a.style.color="#fff"}const e=this.input.getVector(),s=this.player.update(e,this.mapSystem,t,this.currentStageEffects,this.windData);if(s==="DIE"){this.gameOver();return}s==="FILL"&&(console.log(`üéÆ Calling fillAreas with ${this.monsters.length} monsters`),this.mapSystem.fillAreas(this.monsters,this.player.lastTrail),this.monsters=this.monsters.filter(a=>this.mapSystem.getCell(a.x,a.y)!==o.CELL_TYPE.OWNED));const i=this.mapSystem.getOwnedPercentage();this.uiAreaScore.textContent=i.toFixed(1),this.uiMonsterCount&&(this.uiMonsterCount.textContent=this.monsters.length),i>=85&&this.nextStage();for(const a of this.monsters)if(a.update(this.mapSystem),a.checkCollision(this.player,this.mapSystem)){this.gameOver();return}if(this.mapSystem.boss){if(this.mapSystem.boss.update(this.mapSystem,t,this.player),this.mapSystem.boss.checkCollision(this.player,this.mapSystem)){this.gameOver();return}if(this.mapSystem.boss.lastSkillResult==="KILL"){this.gameOver();return}this.mapSystem.boss.lastSkillResult=null}}formatTime(t){const e=Math.floor(t/60),s=t%60;return`${e.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`}nextStage(){this.isTransitioning=!0,this.uiTransition.style.display="flex",setTimeout(()=>{this.startStage(this.currentLevel+1)},2e3)}gameOver(){this.isRunning=!1,this.uiGameOver.style.display="flex"}revivePlayer(){this.uiGameOver.style.display="none",this.isRunning=!0,this.isPaused=!1,this.lastTime=performance.now();const t=this.mapSystem.width/2,e=this.mapSystem.height/2;if(this.player.x=t,this.player.y=e,this.mapSystem.clearTrails(),this.player.trail=[],this.player.isDrawing=!1,this.mapSystem.boss&&Math.hypot(this.mapSystem.boss.x-t,this.mapSystem.boss.y-e)<300){let i,a;do i=Math.random()*this.mapSystem.width,a=Math.random()*this.mapSystem.height;while(Math.hypot(i-t,a-e)<300);this.mapSystem.boss.x=i,this.mapSystem.boss.y=a,this.mapSystem.boss.state="MOVING",this.mapSystem.boss.targetArea=null}for(const s of this.monsters){const i=Math.hypot(s.x-t,s.y-e),a=this.mapSystem.getCell(s.x,s.y);if(i<200||a===o.CELL_TYPE.OWNED){let r,n,h=0;do r=Math.random()*this.mapSystem.width,n=Math.random()*this.mapSystem.height,this.mapSystem.getCell(r,n),h++;while((Math.hypot(r-t,n-e)<200||this.mapSystem.getCell(r,n)===o.CELL_TYPE.OWNED)&&h<50);h<50&&(s.x=r,s.y=n,console.log(`  Moved monster to UNOWNED area at (${r.toFixed(1)}, ${n.toFixed(1)})`))}}this.timeLimit&&(this.timeLeft=this.timeLimit),requestAnimationFrame(this.loop)}draw(){if(!this.player)return;const t=this.stageManager.getStageData(this.currentLevel).theme;this.renderer.render(this.mapSystem,this.player,this.monsters,t,this.windData,this.currentStageEffects)}loop(t){const e=t-this.lastTime;this.lastTime=t,this.update(e),this.draw(),(this.isRunning||this.isPaused||this.isTransitioning)&&requestAnimationFrame(this.loop)}updateWindDirection(){if(!this.windData)return;const t=Math.random()*Math.PI*2;this.windData.angle=t,this.windData.direction={x:Math.cos(t),y:Math.sin(t)},console.log(`Wind changed: angle=${(t*180/Math.PI).toFixed(0)}`)}}console.log("üöÄ main.js loaded - Version 2025-12-09");async function N(){console.log("üéÆ Initializing game..."),await L(),new W,console.log("‚úÖ Game initialized successfully")}N();
