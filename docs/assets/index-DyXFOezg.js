(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=e(i);fetch(i.href,a)}})();const M={APPENTOS_APP_KEY:"cut-the-land",ENV:"development",ADMOB_INTERSTITIAL_ID:"ca-app-pub-3940256099942544/1033173712"};let I=!1;async function L(){if(I){console.log("Bedrock already initialized");return}window.Bedrock||(console.warn("‚ö†Ô∏è Bedrock SDK not found. Initializing Mock SDK for development."),T());try{const{Bedrock:g}=window;await g.init({appKey:M.APPENTOS_APP_KEY,env:M.ENV}),console.log("‚úÖ Bedrock initialized successfully"),I=!0,k()}catch(g){console.error("‚ùå Bedrock initialization failed:",g),console.warn("Running in development mode with limited Bedrock features")}}let E=!1;async function v(){if(window.Bedrock)try{console.log("‚è≥ Loading Interstitial Ad (2.0)..."),await window.Bedrock.loadAppsInTossAdMob({adUnitId:M.ADMOB_INTERSTITIAL_ID,adType:"interstitial"}),E=!0,console.log("‚úÖ Interstitial Ad Loaded (2.0)")}catch(g){console.warn("‚ùå Failed to load Interstitial Ad:",g),E=!1}}function C(){return new Promise(g=>{if(!E){console.log("‚ö†Ô∏è Ad not loaded, skipping..."),v(),g();return}try{console.log("üì∫ Showing Interstitial Ad (2.0)..."),window.Bedrock.showAppsInTossAdMob().then(()=>{console.log("‚úÖ Ad shown successfully (2.0)"),E=!1,v(),g()}).catch(t=>{console.warn("‚ùå Failed to show Ad:",t),g()})}catch(t){console.warn("‚ùå Error calling showAd:",t),g()}})}function T(){window.Bedrock={init:()=>Promise.resolve(),exit:()=>{console.log("üõë [Mock] Bedrock.exit() called"),confirm("Ïï± Ï¢ÖÎ£å (Mock)")&&window.close()},loadAppsInTossAdMob:g=>(console.log("üì¶ [Mock] loadAppsInTossAdMob (2.0):",g),new Promise(t=>setTimeout(t,1e3))),showAppsInTossAdMob:()=>(console.log("üì∫ [Mock] showAppsInTossAdMob (2.0) called"),console.log("‚úÖ [Mock] Ad closed (auto-dismissed)"),Promise.resolve())},window.NavigationBar={setTitle:g=>console.log(`üè∑Ô∏è [Mock] NavigationBar.setTitle: ${g}`),setBackButton:g=>{console.log("‚¨ÖÔ∏è [Mock] NavigationBar.setBackButton:",g),window.mockPressBackButton=g.onPress,console.log("üí° ÌÖåÏä§Ìä∏ ÌåÅ: Í∞úÎ∞úÏûê ÎèÑÍµ¨ ÏΩòÏÜîÏóêÏÑú window.mockPressBackButton() ÏùÑ Ïã§ÌñâÌïòÏó¨ Îí§Î°úÍ∞ÄÍ∏∞ ÎèôÏûëÏùÑ ÌÖåÏä§Ìä∏ÌïòÏÑ∏Ïöî.")}}}function k(){try{const{NavigationBar:g}=window;if(!g)return;g.setTitle("Cut the Land"),g.setBackButton({visible:!0,onPress:_}),console.log("‚úÖ Navigation bar configured")}catch(g){console.warn("Navigation bar setup failed:",g)}}function _(){if(console.log("‚¨ÖÔ∏è Handle Back Button Pressed"),confirm("Í≤åÏûÑÏùÑ Ï¢ÖÎ£åÌïòÏãúÍ≤†ÏäµÎãàÍπå?"))try{window.Bedrock.exit()}catch(t){console.warn("Cannot exit:",t)}}const n={GAME_WIDTH:600,GAME_HEIGHT:600,GRID_SIZE:1,TILE_SIZE:48,COLORS:{TRAIL:"#ffe189ff"},PLAYER_SPEED:1,MONSTER_SPEED:.5,CELL_TYPE:{UNOWNED:0,OWNED:1,TRAIL:2,WALL:3},THEMES:{forest:{path:"assets/theme/forest",types:["grass","dirt","water"],ratios:[.6,.1,.3],tiles:{grass:["tiles_forest_grass1.png","tiles_forest_grass2.png"],dirt:["tiles_forest_dirt1.png","tiles_forest_dirt2.png"],water:["tiles_forest_water1.png","tiles_forest_water2.png"]},objects:Array.from({length:12},(g,t)=>`obj${String(t+1).padStart(2,"0")}.png`)},ice:{path:"assets/theme/ice",types:["ice","dirt","water"],ratios:[.6,.1,.3],tiles:{ice:["tiles_ice_ice1.png","tiles_ice_ice2.png"],dirt:["tiles_ice_dirt1.png","tiles_ice_dirt2.png"],water:["tiles_ice_water1.png","tiles_ice_water2.png"]},objects:Array.from({length:12},(g,t)=>`obj${String(t+1).padStart(2,"0")}.png`)},wind:{path:"assets/theme/wind",types:["dirt","grass","water"],ratios:[.85,.05,.1],tiles:{dirt:["tiles_wind_dirt1.png","tiles_wind_dirt2.png"],grass:["tiles_wind_grass1.png","tiles_wind_grass2.png"],water:["tiles_wind_water1.png","tiles_wind_water2.png"]},objects:Array.from({length:12},(g,t)=>`obj${String(t+1).padStart(2,"0")}.png`)},space:{path:"assets/theme/space",types:["void","wreck","dust"],ratios:[.8,.05,.15],tiles:{void:["tiles_space_void1.png","tiles_space_void2.png"],wreck:["tiles_space_wreck1.png","tiles_space_wreck2.png"],dust:["tiles_space_dust1.png","tiles_space_dust2.png"]},objects:Array.from({length:12},(g,t)=>`obj${String(t+1).padStart(2,"0")}.png`)},volcano:{path:"assets/theme/volcano",types:["dust","lava","ore"],ratios:[.5,.4,.1],tiles:{dust:["tiles_volcano_dust1.png","tiles_volcano_dust2.png"],lava:["tiles_volcano_lava1.png","tiles_volcano_lava2.png"],ore:["tiles_volcano_ore1.png","tiles_volcano_ore2.png"]},objects:Array.from({length:12},(g,t)=>`obj${String(t+1).padStart(2,"0")}.png`)}}};class P{constructor(){this.joystick={x:0,y:0,active:!1},this.keys={ArrowUp:!1,ArrowDown:!1,ArrowLeft:!1,ArrowRight:!1,w:!1,a:!1,s:!1,d:!1},this.startPos={x:0,y:0},this.currentPos={x:0,y:0},this.maxRadius=50,this.setupTouchEvents(),this.setupMouseEvents(),this.setupKeyboardEvents()}setupTouchEvents(){const t=document.getElementById("game-canvas");t&&(t.addEventListener("touchstart",e=>{e.preventDefault();const s=e.touches[0];this.startPos={x:s.clientX,y:s.clientY},this.joystick.active=!0,this.showJoystick(s.clientX,s.clientY)},{passive:!1}),t.addEventListener("touchmove",e=>{if(e.preventDefault(),!this.joystick.active)return;const s=e.touches[0];this.currentPos={x:s.clientX,y:s.clientY},this.handleJoystickMove(this.currentPos.x,this.currentPos.y)},{passive:!1}),t.addEventListener("touchend",e=>{e.preventDefault(),this.joystick={x:0,y:0,active:!1},this.hideJoystick()}))}setupMouseEvents(){const t=document.getElementById("game-canvas");if(!t)return;let e=!1;t.addEventListener("mousedown",s=>{s.preventDefault(),e=!0,this.startPos={x:s.clientX,y:s.clientY},this.joystick.active=!0,this.showJoystick(s.clientX,s.clientY)}),window.addEventListener("mousemove",s=>{e&&(s.preventDefault(),this.currentPos={x:s.clientX,y:s.clientY},this.handleJoystickMove(this.currentPos.x,this.currentPos.y))}),window.addEventListener("mouseup",s=>{e&&(s.preventDefault(),e=!1,this.joystick={x:0,y:0,active:!1},this.hideJoystick())})}setupKeyboardEvents(){window.addEventListener("keydown",t=>{this.keys.hasOwnProperty(t.key)&&(this.keys[t.key]=!0)}),window.addEventListener("keyup",t=>{this.keys.hasOwnProperty(t.key)&&(this.keys[t.key]=!1)})}handleJoystickMove(t,e){let s=t-this.startPos.x,i=e-this.startPos.y,a=Math.sqrt(s*s+i*i);if(a>this.maxRadius){const h=Math.atan2(i,s),c=t-Math.cos(h)*this.maxRadius,l=e-Math.sin(h)*this.maxRadius;this.startPos={x:c,y:l},this.showJoystick(c,l),s=t-this.startPos.x,i=e-this.startPos.y,a=this.maxRadius}const o=Math.atan2(i,s),r=Math.min(a,this.maxRadius);this.joystick.x=Math.cos(o)*(r/this.maxRadius),this.joystick.y=Math.sin(o)*(r/this.maxRadius),this.updateJoystickUI(r,o)}updateJoystickUI(t,e){const s=document.getElementById("joystick-knob");if(!s)return;const i=Math.cos(e)*t,a=Math.sin(e)*t;s.style.transform=`translate(calc(-50% + ${i}px), calc(-50% + ${a}px))`}showJoystick(t,e){const s=document.getElementById("joystick-container");s&&(s.style.left=t+"px",s.style.top=e+"px",s.style.display="block")}hideJoystick(){const t=document.getElementById("joystick-container"),e=document.getElementById("joystick-knob");t&&(t.style.display="none"),e&&(e.style.transform="translate(-50%, -50%)")}getVector(){if(this.joystick.active)return{x:this.joystick.x,y:this.joystick.y};let t=0,e=0;if((this.keys.ArrowLeft||this.keys.a)&&(t-=1),(this.keys.ArrowRight||this.keys.d)&&(t+=1),(this.keys.ArrowUp||this.keys.w)&&(e-=1),(this.keys.ArrowDown||this.keys.s)&&(e+=1),t!==0||e!==0){const s=Math.sqrt(t*t+e*e);t/=s,e/=s}return{x:t,y:e}}}class b{constructor(){this.images={},this.loaded=!1}async loadTheme(t){const e=n.THEMES[t];if(!e){console.error(`[AssetManager] Theme ${t} not found`);return}const s=[];for(const[i,a]of Object.entries(e.tiles))a.forEach(o=>{const r=o,h=`${e.path}/${o}`;s.push(this.loadImage(r,h))});e.objects.forEach(i=>{const a=i,o=`${e.path}/${i}`;s.push(this.loadImage(a,o))}),s.push(this.loadImage("player",`${e.path}/player_moving.png`,!0)),s.push(this.loadImage("monster",`${e.path}/monster.png`,!0)),s.push(this.loadImage("boss","assets/monster_boss.png",!0)),s.push(this.loadImage("bossSkill","assets/monster_boss_skill.png",!0)),await Promise.all(s),this.loaded=!0,console.log(`[AssetManager] Theme ${t} loaded`)}loadImage(t,e,s=!1){return new Promise((i,a)=>{const o=new Image;o.crossOrigin="anonymous",o.onload=()=>{s?this.images[t]=this.removeCheckerboard(o):this.images[t]=o,i(this.images[t])},o.onerror=r=>{console.error(`[AssetManager] Failed to load ${e}`,r),i(null)},o.src=e})}removeCheckerboard(t){const e=document.createElement("canvas");e.width=t.width,e.height=t.height;const s=e.getContext("2d");s.drawImage(t,0,0);const i=s.getImageData(0,0,e.width,e.height),a=i.data;for(let o=0;o<a.length;o+=4){const r=a[o],h=a[o+1],c=a[o+2],l=r>240&&h>240&&c>240,d=r>180&&r<200&&h>180&&h<200&&c>180&&c<200;(l||d)&&(a[o+3]=0)}return s.putImageData(i,0,0),e}getImage(t){return this.images[t]}}class D{constructor(t){this.canvas=t,this.ctx=t.getContext("2d"),this.assetManager=new b,this.terrainCanvas=document.createElement("canvas"),this.terrainCtx=this.terrainCanvas.getContext("2d"),this.terrainRendered=!1,this.fogCanvas=document.createElement("canvas"),this.fogCtx=this.fogCanvas.getContext("2d"),this.maskCanvas=document.createElement("canvas"),this.maskCtx=this.maskCanvas.getContext("2d"),this.commonImages={},this.processedCommonImages={},this.camera={x:0,y:0,width:0,height:0},this.zoomLevel=1.5,this.snowParticles=[],this.initSnow(),this.windParticles=[],this.initWind(),this.captureEffects=[],this.init()}init(){this.worldWidth=n.GAME_WIDTH,this.worldHeight=n.GAME_HEIGHT,this.initAsync()}async initAsync(){try{this.resize(),window.addEventListener("resize",()=>this.resize())}catch(t){console.error("[Renderer] Init failed:",t)}}setWorldSize(t,e){this.worldWidth=t,this.worldHeight=e,this.resize()}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.canvas.style.width="100%",this.canvas.style.height="100%",this.camera.width=this.canvas.width/this.zoomLevel,this.camera.height=this.canvas.height/this.zoomLevel,this.ctx.imageSmoothingEnabled=!1,this.ctx.webkitImageSmoothingEnabled=!1,this.ctx.mozImageSmoothingEnabled=!1,this.ctx.msImageSmoothingEnabled=!1,this.terrainCanvas.width=this.worldWidth,this.terrainCanvas.height=this.worldHeight,this.terrainCtx.imageSmoothingEnabled=!1,this.terrainCtx.webkitImageSmoothingEnabled=!1,this.terrainCtx.mozImageSmoothingEnabled=!1,this.terrainCtx.msImageSmoothingEnabled=!1,this.fogCanvas.width=this.worldWidth,this.fogCanvas.height=this.worldHeight,this.fogCtx.imageSmoothingEnabled=!1,this.fogCtx.webkitImageSmoothingEnabled=!1,this.fogCtx.mozImageSmoothingEnabled=!1,this.fogCtx.msImageSmoothingEnabled=!1,this.maskCanvas.width=this.worldWidth,this.maskCanvas.height=this.worldHeight,this.maskCtx.imageSmoothingEnabled=!1,this.maskCtx.webkitImageSmoothingEnabled=!1,this.maskCtx.mozImageSmoothingEnabled=!1,this.maskCtx.msImageSmoothingEnabled=!1,this.assetManager.loaded&&(this.terrainRendered=!1),this.needsRedraw=!0}updateCamera(t){this.camera.x=t.x-this.camera.width/2,this.camera.y=t.y-this.camera.height/2,this.worldWidth<this.camera.width?this.camera.x=-(this.camera.width-this.worldWidth)/2:this.camera.x=Math.max(0,Math.min(this.camera.x,this.worldWidth-this.camera.width)),this.worldHeight<this.camera.height?this.camera.y=-(this.camera.height-this.worldHeight)/2:this.camera.y=Math.max(0,Math.min(this.camera.y,this.worldHeight-this.camera.height))}clear(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}render(t,e,s,i,a,o){this.clear(),this.updateCamera(e),this.ctx.save(),this.ctx.scale(this.zoomLevel,this.zoomLevel),this.ctx.translate(-this.camera.x,-this.camera.y),this.drawMap(t,i,e),this.drawPlayer(e),this.drawMonsters(s),t.boss&&this.drawBoss(t.boss),i==="wind"&&a&&this.drawWindIndicator(e,a),this.ctx.restore(),i==="ice"?(this.updateSnow(),this.drawSnow()):i==="wind"&&a&&(this.updateWind(a),this.drawWind(a)),o&&o.type==="dark_fog"&&o.active&&this.drawDarkFog(e),this.ctx.save(),this.ctx.scale(this.zoomLevel,this.zoomLevel),this.ctx.translate(-this.camera.x,-this.camera.y),this.drawCaptureEffects(),this.ctx.restore()}renderTerrainLayer(t){if(!this.assetManager.loaded||!t.tileMap||t.tileMap.length===0)return;this.terrainCtx.clearRect(0,0,this.terrainCanvas.width,this.terrainCanvas.height);const e=n.TILE_SIZE;for(let s=0;s<t.tileRows;s++)for(let i=0;i<t.tileCols;i++){const a=t.tileMap[s][i];if(a){const o=this.assetManager.getImage(a);o&&o.complete&&this.terrainCtx.drawImage(o,i*e,s*e,e,e)}}for(const s of t.objects){const i=this.assetManager.getImage(s.image);i&&i.complete&&this.terrainCtx.drawImage(i,s.x,s.y)}this.terrainRendered=!0}drawMap(t,e,s){if(this.assetManager.loaded&&!this.terrainRendered&&this.renderTerrainLayer(t),this.ctx.drawImage(this.terrainCanvas,0,0),t.isDirty||this.needsRedraw){this.maskCtx.fillStyle="#FFF";const a=t.grid;this.maskCtx.clearRect(0,0,this.maskCanvas.width,this.maskCanvas.height);const o=this.maskCanvas.width,r=this.maskCanvas.height,h=this.maskCtx.getImageData(0,0,o,r),c=h.data;for(let l=0;l<t.rows;l++)for(let d=0;d<t.cols;d++)if(a[l][d]===n.CELL_TYPE.OWNED){const f=(l*o+d)*4;c[f]=255,c[f+1]=255,c[f+2]=255,c[f+3]=255}this.maskCtx.putImageData(h,0,0),t.isDirty=!1,this.needsRedraw=!1}this.fogCtx.clearRect(0,0,this.fogCanvas.width,this.fogCanvas.height),this.fogCtx.globalCompositeOperation="source-over",e==="space"?this.fogCtx.fillStyle="rgba(255, 255, 255, 0.8)":this.fogCtx.fillStyle="rgba(0, 0, 0, 0.8)",this.fogCtx.fillRect(0,0,this.fogCanvas.width,this.fogCanvas.height),this.fogCtx.globalCompositeOperation="destination-out",this.fogCtx.shadowBlur=3,this.fogCtx.shadowColor="#000";const i=2e4;if(this.fogCtx.shadowOffsetX=i,this.fogCtx.shadowOffsetY=0,this.fogCtx.drawImage(this.maskCanvas,-i,0),this.fogCtx.shadowOffsetX=0,this.fogCtx.shadowOffsetY=0,this.fogCtx.shadowBlur=2,this.fogCtx.shadowColor="transparent",this.ctx.drawImage(this.fogCanvas,0,0),s&&s.trail&&s.trail.length>0){const a=Math.max(n.GRID_SIZE,3);this.ctx.save(),this.ctx.strokeStyle=n.COLORS.TRAIL,this.ctx.lineWidth=a,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.beginPath();const o=s.trail[0];Math.floor(o.x/n.GRID_SIZE)*n.GRID_SIZE+a/2,this.ctx.moveTo(o.x,o.y);for(let r=1;r<s.trail.length;r++){const h=s.trail[r];this.ctx.lineTo(h.x,h.y)}this.ctx.lineTo(s.x,s.y),this.ctx.stroke(),this.ctx.restore()}}drawPlayer(t){const e=this.assetManager.getImage("player"),s=t.scale||1;if(e){const i=24*s,a=48;this.ctx.drawImage(e,t.currentFrame*a,0,a,a,t.x-i/2,t.y-i/2,i,i)}else this.ctx.fillStyle="#2196F3",this.ctx.beginPath(),this.ctx.arc(t.x,t.y,t.radius,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle="#FFF",this.ctx.lineWidth=2,this.ctx.stroke()}drawMonsters(t){const e=this.assetManager.getImage("monster");for(const s of t){const i=s.scale||1;if(e){const a=24*i,o=48;this.ctx.drawImage(e,s.currentFrame*o,0,o,o,s.x-a/2,s.y-a/2,a,a)}else this.ctx.fillStyle="#F44336",this.ctx.beginPath(),this.ctx.arc(s.x,s.y,s.radius,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle="#FFF",this.ctx.lineWidth=2,this.ctx.stroke()}}drawBoss(t){if(!t)return;if(t.state==="CASTING"&&t.targetArea){const{x:s,y:i,radius:a}=t.targetArea;this.ctx.fillStyle="rgba(244, 67, 54, 0.3)",this.ctx.beginPath(),this.ctx.arc(s,i,a,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle="rgba(244, 67, 54, 0.8)",this.ctx.lineWidth=2,this.ctx.stroke();const o=t.castTimer%1e3/1e3,r=a*(1-o);this.ctx.fillStyle="rgba(244, 67, 54, 0.5)",this.ctx.beginPath(),this.ctx.arc(s,i,r,0,Math.PI*2),this.ctx.fill()}let e=this.assetManager.getImage("boss");if(t.state==="CASTING"){const s=this.assetManager.getImage("bossSkill");s&&(e=s)}e?this.ctx.drawImage(e,t.currentFrame*48,0,48,48,t.x-40/2,t.y-40/2,40,40):(this.ctx.fillStyle="#9C27B0",this.ctx.beginPath(),this.ctx.arc(t.x,t.y,t.radius,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle="#FFF",this.ctx.lineWidth=3,this.ctx.stroke())}initSnow(){this.snowParticles=Array.from({length:100},()=>({x:Math.random()*window.innerWidth,y:Math.random()*window.innerHeight,radius:Math.random()*2+1,speed:Math.random()*1+.5,opacity:Math.random()*.5+.3}))}updateSnow(){for(const t of this.snowParticles)t.y+=t.speed,t.y>window.innerHeight&&(t.y=-5,t.x=Math.random()*window.innerWidth)}drawSnow(){this.ctx.fillStyle="#FFF";for(const t of this.snowParticles)this.ctx.globalAlpha=t.opacity,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,t.radius,0,Math.PI*2),this.ctx.fill();this.ctx.globalAlpha=1}initWind(){this.windParticles=Array.from({length:50},()=>({x:Math.random()*window.innerWidth,y:Math.random()*window.innerHeight,length:Math.random()*20+10,speed:Math.random()*2+2,opacity:Math.random()*.3+.1}))}updateWind(t){for(const e of this.windParticles)e.x+=t.direction.x*e.speed,e.y+=t.direction.y*e.speed,e.x<-50&&(e.x=window.innerWidth+50),e.x>window.innerWidth+50&&(e.x=-50),e.y<-50&&(e.y=window.innerHeight+50),e.y>window.innerHeight+50&&(e.y=-50)}drawWind(t){this.ctx.strokeStyle="rgba(255, 255, 255, 0.5)",this.ctx.lineWidth=1;for(const e of this.windParticles)this.ctx.globalAlpha=e.opacity,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(e.x-t.direction.x*e.length,e.y-t.direction.y*e.length),this.ctx.stroke();this.ctx.globalAlpha=1}drawWindIndicator(t,e){const s=t.x,i=t.y-60;this.ctx.save(),this.ctx.translate(s,i),this.ctx.fillStyle="#333",this.ctx.beginPath(),this.ctx.arc(0,0,3,0,Math.PI*2),this.ctx.fill(),this.ctx.rotate(e.angle),this.ctx.strokeStyle="#D32F2F",this.ctx.lineWidth=2,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.beginPath(),this.ctx.moveTo(-15,0),this.ctx.lineTo(15,0),this.ctx.stroke(),this.ctx.fillStyle="#D32F2F",this.ctx.beginPath(),this.ctx.moveTo(18,0),this.ctx.lineTo(10,-6),this.ctx.lineTo(10,6),this.ctx.closePath(),this.ctx.fill(),this.ctx.beginPath(),this.ctx.moveTo(-15,0),this.ctx.lineTo(-22,-7),this.ctx.lineTo(-22,7),this.ctx.closePath(),this.ctx.fill(),this.ctx.restore()}drawDarkFog(t){this.ctx.save(),this.ctx.fillStyle="#000",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.globalCompositeOperation="destination-out";const e=(t.x-this.camera.x)*this.zoomLevel,s=(t.y-this.camera.y)*this.zoomLevel,i=100;this.ctx.beginPath(),this.ctx.arc(e,s,i,0,Math.PI*2),this.ctx.fill(),this.ctx.restore()}addCaptureEffect(t){this.captureEffects.push({cells:t,timer:0,duration:1e3,opacity:1})}drawCaptureEffects(){if(this.captureEffects.length===0)return;const t=n.GRID_SIZE;this.captureEffects.forEach(e=>{e.timer+=16.6,e.opacity=1-e.timer/e.duration}),this.captureEffects=this.captureEffects.filter(e=>e.timer<e.duration);for(const e of this.captureEffects)if(!(e.opacity<=0)){this.ctx.save(),this.ctx.globalAlpha=e.opacity,this.ctx.fillStyle=n.COLORS.TRAIL,this.ctx.beginPath();for(const s of e.cells){const i=Math.floor(s.x/n.GRID_SIZE)*n.GRID_SIZE,a=Math.floor(s.y/n.GRID_SIZE)*n.GRID_SIZE;this.ctx.rect(i,a,t,t)}this.ctx.fill(),this.ctx.restore()}}}class A{constructor(){this.grid=[],this.tileMap=[],this.objects=[],this.reset()}reset(t=1,e="forest"){this.width=Math.floor(n.GAME_WIDTH*t),this.height=Math.floor(n.GAME_HEIGHT*t),this.cols=Math.ceil(this.width/n.GRID_SIZE),this.rows=Math.ceil(this.height/n.GRID_SIZE),this.tileCols=Math.ceil(this.width/n.TILE_SIZE),this.tileRows=Math.ceil(this.height/n.TILE_SIZE),this.grid=Array(this.rows).fill().map(()=>Array(this.cols).fill(n.CELL_TYPE.UNOWNED));const s=Math.floor(this.cols/2),i=Math.floor(this.rows/2),a=40;for(let o=-a;o<=a;o++)for(let r=-a;r<=a;r++)if(r*r+o*o<=a*a){const h=s+r,c=i+o;this.isValid(h,c)&&(this.grid[c][h]=n.CELL_TYPE.OWNED)}this.generateTerrain(e)}generateTerrain(t){const e=n.THEMES[t];if(!e)return;this.tileMap=Array(this.tileRows).fill().map(()=>Array(this.tileCols).fill(null));let s=Array(this.tileRows).fill().map(()=>Array(this.tileCols).fill(0));const i=e.ratios[0],a=e.ratios[1];for(let c=0;c<this.tileRows;c++)for(let l=0;l<this.tileCols;l++){const d=Math.random();d<i?s[c][l]=0:d<i+a?s[c][l]=1:s[c][l]=2}const o=4;for(let c=0;c<o;c++){const l=s.map(d=>[...d]);for(let d=0;d<this.tileRows;d++)for(let f=0;f<this.tileCols;f++){const m={0:0,1:0,2:0};for(let u=-1;u<=1;u++)for(let y=-1;y<=1;y++){if(y===0&&u===0)continue;const p=d+u,x=f+y;p>=0&&p<this.tileRows&&x>=0&&x<this.tileCols?m[s[p][x]]++:m[s[d][f]]++}m[2]>4?l[d][f]=2:m[1]>4?l[d][f]=1:m[0]>4&&(l[d][f]=0)}s=l}const r=e.types;for(let c=0;c<this.tileRows;c++)for(let l=0;l<this.tileCols;l++){const d=s[c][l],f=r[d],m=e.tiles[f];m&&m.length>0?this.tileMap[c][l]=m[Math.floor(Math.random()*m.length)]:console.warn(`[MapSystem] Missing variants for theme ${t} type ${f}`)}this.objects=[];const h=(c,l,d,f)=>{if(s[l][c]===2)return!1;for(const m of this.objects)if(Math.hypot(m.x-d,m.y-f)<n.TILE_SIZE*.8)return!1;return!0};for(const c of e.objects){const l=Math.floor(Math.random()*3)+1;for(let d=0;d<l;d++){let f=0,m=!1;for(;f<20&&!m;){const u=Math.floor(Math.random()*this.tileCols),y=Math.floor(Math.random()*this.tileRows),p=Math.random()*(n.TILE_SIZE/2),x=Math.random()*(n.TILE_SIZE/2),w=u*n.TILE_SIZE+p,S=y*n.TILE_SIZE+x;h(u,y,w,S)&&(this.objects.push({x:w,y:S,image:c}),m=!0),f++}}}}getCell(t,e){const s=Math.floor(t/n.GRID_SIZE),i=Math.floor(e/n.GRID_SIZE);return s<0||s>=this.cols||i<0||i>=this.rows?null:this.grid[i][s]}setCell(t,e,s){const i=Math.floor(t/n.GRID_SIZE),a=Math.floor(e/n.GRID_SIZE);i>=0&&i<this.cols&&a>=0&&a<this.rows&&(this.grid[a][i]=s)}isValid(t,e){return t>=0&&t<this.cols&&e>=0&&e<this.rows}findEmptyAreas(){const t=Array(this.rows).fill().map(()=>Array(this.cols).fill(!1)),e=[];for(let s=0;s<this.rows;s++)for(let i=0;i<this.cols;i++)if(this.grid[s][i]===n.CELL_TYPE.UNOWNED&&!t[s][i]){const a=[],o=[{x:i,y:s}];t[s][i]=!0;let r=!1;for(;o.length>0;){const h=o.pop();a.push(h),(h.x===0||h.x===this.cols-1||h.y===0||h.y===this.rows-1)&&(r=!0);const c=[{x:h.x+1,y:h.y},{x:h.x-1,y:h.y},{x:h.x,y:h.y+1},{x:h.x,y:h.y-1}];for(const l of c)this.isValid(l.x,l.y)&&!t[l.y][l.x]&&this.grid[l.y][l.x]===n.CELL_TYPE.UNOWNED&&(t[l.y][l.x]=!0,o.push(l))}r?console.log(`  ‚ö†Ô∏è Skipping border area (${a.length} cells)`):e.push(a)}return e}fillAreas(t,e=[]){console.log("üéØ fillAreas called with currentTrail:",e);for(const o of e){const r=Math.floor(o.x/n.GRID_SIZE),h=Math.floor(o.y/n.GRID_SIZE);this.isValid(r,h)&&this.grid[h][r]===n.CELL_TYPE.TRAIL&&(this.grid[h][r]=n.CELL_TYPE.OWNED)}this.isDirty=!0;const s=this.findEmptyAreas();console.log(`  Found ${s.length} empty areas`);let i=0;if(s.length===0){for(let o=0;o<this.rows;o++)for(let r=0;r<this.cols;r++)this.grid[o][r]===n.CELL_TYPE.TRAIL&&(this.grid[o][r]=n.CELL_TYPE.OWNED);return this.isDirty=!0,0}const a=[];for(const o of s){console.log(`  Filling area (${o.length} cells)`);for(const r of o)this.grid[r.y][r.x]=n.CELL_TYPE.OWNED,a.push(r),i++}this.isDirty=!0;for(let o=0;o<this.rows;o++)for(let r=0;r<this.cols;r++)this.grid[o][r]===n.CELL_TYPE.TRAIL&&(this.grid[o][r]=n.CELL_TYPE.OWNED,a.push({x:r,y:o}));return{count:i,newCells:a}}clearTrails(){for(let t=0;t<this.rows;t++)for(let e=0;e<this.cols;e++)this.grid[t][e]===n.CELL_TYPE.TRAIL&&(this.grid[t][e]=n.CELL_TYPE.UNOWNED)}getOwnedPercentage(){let t=0;const e=this.rows*this.cols;for(let s=0;s<this.rows;s++)for(let i=0;i<this.cols;i++)this.grid[s][i]===n.CELL_TYPE.OWNED&&t++;return t/e*100}}class R{constructor(){this.currentStage=1,this.stages=[{level:1,theme:"forest",mapSize:.8,description:"ÌèâÌôîÎ°úÏö¥ Ïà≤ ÏßÄÏó≠ÏûÖÎãàÎã§. Í∏∞Î≥∏ Ï°∞ÏûëÎ≤ïÏùÑ ÏùµÌòÄÎ≥¥ÏÑ∏Ïöî!",monsters:[{count:2}]},{level:2,theme:"forest",mapSize:1,timeLimit:60,description:"ÏãúÍ∞ÑÏ†úÌïúÏù¥ Ï∂îÍ∞ÄÎê©ÎãàÎã§. Îπ†Î•¥Í≤å ÏòÅÏó≠ÏùÑ ÌôïÎ≥¥ÌïòÏÑ∏Ïöî!",monsters:[{count:3}]},{level:3,theme:"ice",mapSize:1,timeLimit:90,effects:{type:"ice"},description:"ÏñºÏùå ÏßÄÏó≠ÏóêÏÑúÎäî ÏïÑÎûòÎ°ú ÎØ∏ÎÅÑÎü¨ÏßëÎãàÎã§. Ï°∞Ïã¨ÌïòÏÑ∏Ïöî!",monsters:[{count:4}]},{level:4,theme:"wind",mapSize:1,timeLimit:90,effects:{type:"wind"},description:"Í∞ïÌïú Î∞îÎûåÏù¥ Î∞©Ìñ•ÏùÑ Î∞îÍøâÎãàÎã§. Ï†ÅÏùëÌïòÏÑ∏Ïöî!",monsters:[{count:5}]},{level:5,theme:"volcano",mapSize:1.2,timeLimit:90,boss:!0,description:"Ï≤´ Î≥¥Ïä§ Ïä§ÌÖåÏù¥ÏßÄ! Ïö©Ïïî ÏßÄÏó≠Ïùò Î≥¥Ïä§Î•º Î¨ºÎ¶¨ÏπòÏÑ∏Ïöî!",monsters:[{count:3}]},{level:6,theme:"ice",mapSize:1,timeLimit:100,scale:1.1,effects:{type:"ice"},description:"Îçî Í∞ïÎ†•Ìï¥ÏßÑ ÏñºÏùå ÏßÄÏó≠ÏûÖÎãàÎã§. ÎÇúÏù¥ÎèÑÍ∞Ä ÏÉÅÏäπÌï©ÎãàÎã§!",monsters:[{count:5}]},{level:7,theme:"forest",mapSize:1,timeLimit:100,scale:1.1,effects:{type:"dark_fog"},description:"Ïñ¥Îë†Ïùò ÏïàÍ∞úÍ∞Ä ÏãúÏïºÎ•º Í∞ÄÎ¶ΩÎãàÎã§. ÏßëÏ§ëÌïòÏÑ∏Ïöî!",monsters:[{count:5}]},{level:8,theme:"wind",mapSize:1,timeLimit:100,scale:1.1,effects:{type:"wind"},description:"Ìè≠ÌíçÏù¥ Î™∞ÏïÑÏπ©ÎãàÎã§. Î∞îÎûåÏóê ÎßûÏÑú Ïã∏Ïö∞ÏÑ∏Ïöî!",monsters:[{count:5}]},{level:9,theme:"space",mapSize:1,timeLimit:100,scale:1.1,effects:{type:"space_distortion"},description:"Ïö∞Ï£º ÏôúÍ≥°ÏúºÎ°ú ÏàúÍ∞ÑÏù¥ÎèôÏù¥ Î∞úÏÉùÌï©ÎãàÎã§!",monsters:[{count:5}]},{level:10,theme:"volcano",mapSize:1.2,timeLimit:100,scale:1.1,boss:!0,description:"ÏµúÏ¢Ö Î≥¥Ïä§ Ïä§ÌÖåÏù¥ÏßÄ! Î™®Îì† Í≤ÉÏùÑ ÏèüÏïÑÎ∂ÄÏúºÏÑ∏Ïöî!",monsters:[{count:4}]}]}getStageData(t){return this.stages.find(e=>e.level===t)||this.stages[0]}}class B{constructor(t,e,s=1){this.x=t,this.y=e,this.vx=0,this.vy=0,this.radius=8*s,this.scale=s,this.speed=n.PLAYER_SPEED,this.isDrawing=!1,this.trail=[],this.animTimer=0,this.currentFrame=0,this.totalFrames=2,this.frameDuration=200}update(t,e,s,i,a){this.vx=t.x,this.vy=t.y;let o=this.speed;if(i&&i.type==="ice"&&(t.x===0&&t.y===0&&(this.y+=1*s/1e3),t.y<0?o*=.6:t.y>0&&(o*=1.4)),i&&i.type==="wind"&&a&&(t.x!==0||t.y!==0)){const f=1+(t.x*a.direction.x+t.y*a.direction.y)*.4;o*=f}if(i&&i.type==="dark_fog"&&i.active&&(o*=.4),i&&i.type==="space_distortion"&&(o*=.8),t.x===0&&t.y===0&&(!i||i.type!=="ice"))return"IDLE";const r=this.x+t.x*o,h=this.y+t.y*o;if(r<0||r>e.width||h<0||h>e.height)return"BLOCKED";const c=e.getCell(this.x,this.y),l=e.getCell(r,h);if(c===n.CELL_TYPE.OWNED&&l===n.CELL_TYPE.UNOWNED&&(this.isDrawing=!0),this.isDrawing){if(l===n.CELL_TYPE.OWNED)return this.isDrawing=!1,this.x=r,this.y=h,this.lastTrail=[...this.trail],console.log("‚úÖ Player FILL - lastTrail saved:",this.lastTrail.length,"points"),this.trail=[],"FILL";if(l===n.CELL_TYPE.UNOWNED){const d=r-this.x,f=h-this.y,m=Math.hypot(d,f),u=Math.ceil(m);for(let y=1;y<=u;y++){const p=y/u,x=this.x+d*p,w=this.y+f*p;e.setCell(x,w,n.CELL_TYPE.TRAIL),this.trail.push({x,y:w})}}}return this.x=r,this.y=h,this.animTimer+=s,this.animTimer>=this.frameDuration&&(this.animTimer=0,this.currentFrame=(this.currentFrame+1)%this.totalFrames),"MOVE"}teleport(t){let e=!1,s=0,i,a;for(;!e&&s<10;)i=Math.random()*t.width,a=Math.random()*t.height,t.getCell(i,a)!==n.CELL_TYPE.WALL&&(e=!0),s++;e&&(this.x=i,this.y=a,this.isDrawing=!1,this.trail=[])}}class O{constructor(t,e,s=1){this.x=t,this.y=e,this.radius=8*s,this.scale=s,this.speed=n.MONSTER_SPEED;const i=Math.random()*Math.PI*2;this.vx=Math.cos(i)*this.speed,this.vy=Math.sin(i)*this.speed,this.changeDirTimer=0,this.animTimer=0,this.currentFrame=0,this.totalFrames=2,this.frameDuration=200}update(t){if(this.changeDirTimer++,this.changeDirTimer>60){this.changeDirTimer=0;const i=Math.random()*Math.PI*2;this.vx=Math.cos(i)*this.speed,this.vy=Math.sin(i)*this.speed}let e=this.x+this.vx,s=this.y+this.vy;if((e<0||e>t.width)&&(this.vx*=-1,e=Math.max(0,Math.min(t.width,e))),(s<0||s>t.height)&&(this.vy*=-1,s=Math.max(0,Math.min(t.height,s))),t.getCell(e,s)===n.CELL_TYPE.OWNED){this.vx*=-1,this.vy*=-1;const i=Math.random()*Math.PI*2;this.vx=Math.cos(i)*this.speed,this.vy=Math.sin(i)*this.speed}else this.x=e,this.y=s;this.animTimer+=16,this.animTimer>=this.frameDuration&&(this.animTimer=0,this.currentFrame=(this.currentFrame+1)%this.totalFrames)}checkCollision(t,e){const s=this.x-t.x,i=this.y-t.y;return Math.sqrt(s*s+i*i)<this.radius+t.radius?(console.log("Monster collision: Direct hit!"),!0):e.getCell(this.x,this.y)===n.CELL_TYPE.TRAIL?(console.log("Monster collision: Trail hit!"),!0):!1}}class W{constructor(t,e){this.x=t,this.y=e,this.radius=19,this.speed=80,this.angle=Math.random()*Math.PI*2,this.state="MOVING",this.skillTimer=0,this.skillInterval=1e4,this.castDuration=3e3,this.castTimer=0,this.targetArea=null,this.animTimer=0,this.currentFrame=0,this.totalFrames=2,this.frameDuration=200,this.lives=3,this.isInvincible=!1}takeDamage(t){return this.isInvincible?!1:(this.lives--,this.teleportToSafeSpot(t),!0)}teleportToSafeSpot(t){let e=0,s,i;do s=this.radius+Math.random()*(t.width-this.radius*2),i=this.radius+Math.random()*(t.height-this.radius*2),e++;while(t.getCell(s,i)===n.CELL_TYPE.OWNED&&e<50);e>=50&&(s=this.radius+Math.random()*(t.width-this.radius*2),i=this.radius+Math.random()*(t.height-this.radius*2)),this.x=s,this.y=i,this.state="MOVING",this.targetArea=null}update(t,e,s){this.state==="MOVING"?(this.updateMovement(t,e),this.skillTimer+=e,this.skillTimer>=this.skillInterval&&this.startCasting(t)):this.state==="CASTING"&&(this.castTimer+=e,this.castTimer>=this.castDuration&&this.fireSkill(t,s)),this.animTimer+=e,this.animTimer>=this.frameDuration&&(this.animTimer=0,this.currentFrame=(this.currentFrame+1)%this.totalFrames)}updateMovement(t,e){let s=this.x+Math.cos(this.angle)*this.speed*(e/1e3),i=this.y+Math.sin(this.angle)*this.speed*(e/1e3),a=!1;if(s<this.radius&&(s=this.radius,this.angle=Math.PI-this.angle,a=!0),s>t.width-this.radius&&(s=t.width-this.radius,this.angle=Math.PI-this.angle,a=!0),i<this.radius&&(i=this.radius,this.angle=-this.angle,a=!0),i>t.height-this.radius&&(i=t.height-this.radius,this.angle=-this.angle,a=!0),!a){const o=(l,d)=>l<0||l>=t.width||d<0||d>=t.height?!0:t.getCell(l,d)===n.CELL_TYPE.OWNED,r=this.radius+2,h=s+Math.cos(this.angle)*r,c=i+Math.sin(this.angle)*r;if(o(h,c)){const l=this.x+Math.cos(this.angle)*this.speed*(e/1e3),d=this.y+Math.sin(this.angle)*this.speed*(e/1e3),f=o(l+Math.sign(Math.cos(this.angle))*this.radius,this.y),m=o(this.x,d+Math.sign(Math.sin(this.angle))*this.radius);f&&(this.angle=Math.PI-this.angle,a=!0,s=this.x),m&&(this.angle=-this.angle,a=!0,i=this.y),!f&&!m&&(this.angle+=Math.PI,a=!0,s=this.x,i=this.y)}}this.x=s,this.y=i,!a&&Math.random()<.02&&(this.angle+=(Math.random()-.5)*Math.PI)}startCasting(t){this.state="CASTING",this.castTimer=0,this.skillTimer=0;const s=t.width*t.height*.05,i=Math.sqrt(s/Math.PI),a=i,o=a+Math.random()*(t.width-a*2),r=a+Math.random()*(t.height-a*2);this.targetArea={x:o,y:r,radius:i}}fireSkill(t,e){const s=e.x-this.targetArea.x,i=e.y-this.targetArea.y;Math.sqrt(s*s+i*i)<this.targetArea.radius+e.radius?this.lastSkillResult="KILL":this.lastSkillResult="MISS";const o=Math.max(0,Math.floor((this.targetArea.x-this.targetArea.radius)/n.GRID_SIZE)),r=Math.min(t.cols-1,Math.ceil((this.targetArea.x+this.targetArea.radius)/n.GRID_SIZE)),h=Math.max(0,Math.floor((this.targetArea.y-this.targetArea.radius)/n.GRID_SIZE)),c=Math.min(t.rows-1,Math.ceil((this.targetArea.y+this.targetArea.radius)/n.GRID_SIZE));for(let l=h;l<=c;l++)for(let d=o;d<=r;d++){const f=d*n.GRID_SIZE+n.GRID_SIZE/2,m=l*n.GRID_SIZE+n.GRID_SIZE/2,u=f-this.targetArea.x,y=m-this.targetArea.y;u*u+y*y<this.targetArea.radius*this.targetArea.radius&&t.grid[l][d]===n.CELL_TYPE.OWNED&&(t.grid[l][d]=n.CELL_TYPE.UNOWNED)}this.state="MOVING",this.targetArea=null}checkCollision(t,e){const s=this.x-t.x,i=this.y-t.y;if(Math.sqrt(s*s+i*i)<this.radius+t.radius)return!0;const o=Math.floor(this.x/n.GRID_SIZE),r=Math.floor(this.y/n.GRID_SIZE);return o>=0&&o<e.cols&&r>=0&&r<e.rows&&e.grid[r][o]===n.CELL_TYPE.TRAIL}}class N{constructor(){this.canvas=document.getElementById("game-canvas"),this.renderer=new D(this.canvas),this.input=new P,this.mapSystem=new A,this.stageManager=new R,this.currentLevel=1,this.isTransitioning=!1,this.uiAreaScore=document.getElementById("area-score"),this.uiMonsterCount=document.getElementById("monster-count"),this.uiStageLevel=document.getElementById("stage-level"),this.uiResultPopup=document.getElementById("stage-result-popup"),this.uiBossHud=document.getElementById("boss-hud"),this.uiTimer=document.getElementById("ui-timer"),this.startStage(this.currentLevel),this.lastTime=0,this.isRunning=!0,this.isPaused=!1,this.loop=this.loop.bind(this),requestAnimationFrame(this.loop),this.setupControls(),v(),setTimeout(()=>{const t=document.getElementById("bridge-view");t&&t.classList.add("hidden")},1500),setTimeout(()=>{const t=document.getElementById("age-rating");t&&t.classList.add("hidden")},3500)}setupControls(){document.getElementById("pause-btn").addEventListener("click",()=>this.togglePause())}async startStage(t){this.player=null,this.monsters=[],this.mapSystem.boss=null;const e=this.stageManager.getStageData(t);this.currentLevel=t,this.uiStageLevel.textContent=t,this.currentStageEffects=e.effects||{},document.getElementById("loading-screen").style.display="flex",await this.renderer.assetManager.loadTheme(e.theme),document.getElementById("loading-screen").style.display="none",this.currentStageEffects.type==="wind"?(this.windData={direction:{x:1,y:0},angle:0,timer:0,changeInterval:1e4},this.updateWindDirection()):this.windData=null,this.currentStageEffects.type==="dark_fog"&&(this.currentStageEffects.active=!1,this.currentStageEffects.timer=0,this.currentStageEffects.nextTrigger=Math.random()*1e4+15e3,this.currentStageEffects.duration=3e3),this.currentStageEffects.type==="space_distortion"&&(this.currentStageEffects.teleportTimer=0,this.currentStageEffects.nextTeleport=Math.random()*5e3+15e3),this.timeLimit=e.timeLimit,this.timeLeft=this.timeLimit;const s=document.getElementById("ui-timer");this.timeLimit?(s.style.display="block",s.textContent=this.formatTime(this.timeLeft),s.style.color="#fff"):s.style.display="none",this.mapSystem.reset(e.mapSize||1,e.theme),this.renderer.setWorldSize(this.mapSystem.width,this.mapSystem.height);const i=this.mapSystem.width/2,a=this.mapSystem.height/2,o=e.scale||1;if(this.player=new B(i,a,o),this.monsters=[],e&&e.monsters&&e.monsters.forEach(r=>{for(let h=0;h<r.count;h++){let c,l;do c=Math.random()*this.mapSystem.width,l=Math.random()*this.mapSystem.height;while(Math.hypot(c-i,l-a)<200);this.monsters.push(new O(c,l,o))}}),e.boss){let r,h;do r=Math.random()*this.mapSystem.width,h=Math.random()*this.mapSystem.height;while(Math.hypot(r-i,h-a)<300);this.mapSystem.boss=new W(r,h)}else this.mapSystem.boss=null;this.uiLayer=document.getElementById("ui-layer"),this.uiLayer.style.display="flex",this.isTransitioning=!1,this.uiResultPopup.style.display="none",this.mapSystem.boss?(this.uiBossHud.style.display="flex",this.updateBossHud()):this.uiBossHud.style.display="none",this.isRunning=!0,this.lastTime=performance.now()}togglePause(){this.isPaused=!this.isPaused;const t=document.getElementById("pause-btn");this.isPaused?t.innerHTML=`
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M8 5V19L19 12L8 5Z" fill="currentColor"/>
                </svg>
            `:(t.innerHTML=`
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 4H10V20H6V4ZM14 4H18V20H14V4Z" fill="currentColor"/>
                </svg>
            `,this.lastTime=performance.now())}update(t){if(!this.isRunning||this.isPaused||this.isTransitioning||!this.player)return;if(this.windData&&(this.windData.timer+=t,this.windData.timer>=this.windData.changeInterval&&(this.windData.timer=0,this.updateWindDirection())),this.currentStageEffects&&this.currentStageEffects.type==="dark_fog"&&(this.currentStageEffects.timer+=t,this.currentStageEffects.active?this.currentStageEffects.timer>=this.currentStageEffects.duration&&(this.currentStageEffects.active=!1,this.currentStageEffects.timer=0,this.currentStageEffects.nextTrigger=Math.random()*1e4+15e3,console.log("Dark Fog ended")):this.currentStageEffects.timer>=this.currentStageEffects.nextTrigger&&(this.currentStageEffects.active=!0,this.currentStageEffects.timer=0,console.log("Dark Fog started"))),this.currentStageEffects&&this.currentStageEffects.type==="space_distortion"&&(this.currentStageEffects.teleportTimer+=t,this.currentStageEffects.teleportTimer>=this.currentStageEffects.nextTeleport&&(this.currentStageEffects.teleportTimer=0,this.currentStageEffects.nextTeleport=Math.random()*5e3+15e3,this.player.teleport(this.mapSystem),console.log("Player teleported"))),this.timeLimit&&this.timeLeft>0&&(this.timeLeft-=t/1e3,this.timeLeft<=0&&(this.timeLeft=0,this.gameOver()),this.uiTimer)){const a=Math.ceil(this.timeLeft);this.uiTimer.textContent=this.formatTime(a),a<=10?this.uiTimer.style.color="#F44336":a<=20?this.uiTimer.style.color="#FF9800":a<=30?this.uiTimer.style.color="#FFEB3B":this.uiTimer.style.color="#fff"}const e=this.input.getVector(),s=this.player.update(e,this.mapSystem,t,this.currentStageEffects,this.windData);if(s==="DIE"){this.gameOver();return}if(s==="FILL"){console.log(`üéÆ Calling fillAreas with ${this.monsters.length} monsters`);const{count:a,newCells:o}=this.mapSystem.fillAreas(this.monsters,this.player.lastTrail);o&&o.length>0&&this.renderer.addCaptureEffect(o),this.monsters=this.monsters.filter(r=>this.mapSystem.getCell(r.x,r.y)!==n.CELL_TYPE.OWNED)}const i=this.mapSystem.getOwnedPercentage();this.uiAreaScore.textContent=i.toFixed(1),this.uiMonsterCount&&(this.uiMonsterCount.textContent=this.monsters.length),(i>=85||this.monsters.length===0&&!this.mapSystem.boss)&&this.nextStage();for(const a of this.monsters)if(a.update(this.mapSystem),a.checkCollision(this.player,this.mapSystem)){this.gameOver();return}if(this.mapSystem.boss){if(this.mapSystem.boss.update(this.mapSystem,t,this.player),this.mapSystem.boss.checkCollision(this.player,this.mapSystem)){this.gameOver();return}if(this.mapSystem.boss.lastSkillResult==="KILL"){this.gameOver();return}this.mapSystem.boss.lastSkillResult=null,this.mapSystem.getCell(this.mapSystem.boss.x,this.mapSystem.boss.y)===n.CELL_TYPE.OWNED&&this.mapSystem.boss.takeDamage(this.mapSystem)&&(console.log(`Boss took damage! Lives left: ${this.mapSystem.boss.lives}`),this.updateBossHud(),this.mapSystem.boss.lives<=0&&(console.log("Boss Defeated!"),this.mapSystem.boss=null,this.uiBossHud.style.display="none"))}}updateBossHud(){if(!this.mapSystem.boss)return;this.uiBossHud.querySelectorAll(".boss-heart").forEach((e,s)=>{s<this.mapSystem.boss.lives?e.classList.add("active"):e.classList.remove("active")})}formatTime(t){const e=Math.floor(t/60),s=t%60;return`${e.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`}nextStage(){this.isTransitioning=!0;const t=this.currentLevel+1,e=this.stageManager.getStageData(t);this.showResultPopup(!0,`STAGE ${t}`,e?.description||"Îã§Ïùå Ïä§ÌÖåÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§.",()=>this.startStage(t))}gameOver(){this.isRunning=!1;const t=this.stageManager.getStageData(this.currentLevel);this.showResultPopup(!1,`STAGE ${this.currentLevel}`,t?.description||"Îã§Ïãú ÎèÑÏ†ÑÌï¥Î≥¥ÏÑ∏Ïöî!",null)}revivePlayer(){this.uiResultPopup.style.display="none",this.isRunning=!0,this.isPaused=!1,this.lastTime=performance.now();let t=this.mapSystem.width/2,e=this.mapSystem.height/2;if(this.mapSystem.getCell(t,e)!==n.CELL_TYPE.OWNED){let s=!1,i=0;for(;!s&&i<100;){const a=Math.random()*this.mapSystem.width,o=Math.random()*this.mapSystem.height;this.mapSystem.getCell(a,o)===n.CELL_TYPE.OWNED&&(t=a,e=o,s=!0),i++}s||(t=10,e=10)}if(this.player.x=t,this.player.y=e,this.mapSystem.clearTrails(),this.player.trail=[],this.player.isDrawing=!1,this.mapSystem.boss&&Math.hypot(this.mapSystem.boss.x-t,this.mapSystem.boss.y-e)<300){let i,a;do i=Math.random()*this.mapSystem.width,a=Math.random()*this.mapSystem.height;while(Math.hypot(i-t,a-e)<300);this.mapSystem.boss.x=i,this.mapSystem.boss.y=a,this.mapSystem.boss.state="MOVING",this.mapSystem.boss.targetArea=null}for(const s of this.monsters){const i=Math.hypot(s.x-t,s.y-e),a=this.mapSystem.getCell(s.x,s.y);if(i<200||a===n.CELL_TYPE.OWNED){let o,r,h=0;do o=Math.random()*this.mapSystem.width,r=Math.random()*this.mapSystem.height,this.mapSystem.getCell(o,r),h++;while((Math.hypot(o-t,r-e)<200||this.mapSystem.getCell(o,r)===n.CELL_TYPE.OWNED)&&h<50);h<50&&(s.x=o,s.y=r)}}this.timeLimit&&(this.timeLeft=this.timeLimit),requestAnimationFrame(this.loop)}draw(){if(!this.player)return;const t=this.stageManager.getStageData(this.currentLevel).theme;this.renderer.render(this.mapSystem,this.player,this.monsters,t,this.windData,this.currentStageEffects)}loop(t){const e=t-this.lastTime;this.lastTime=t,this.update(e),this.draw(),(this.isRunning||this.isPaused||this.isTransitioning)&&requestAnimationFrame(this.loop)}updateWindDirection(){if(!this.windData)return;const t=Math.random()*Math.PI*2;this.windData.angle=t,this.windData.direction={x:Math.cos(t),y:Math.sin(t)},console.log(`Wind changed: angle=${(t*180/Math.PI).toFixed(0)}`)}showResultPopup(t,e,s,i){const a=document.getElementById("result-title"),o=document.getElementById("result-description"),r=document.getElementById("result-buttons");if(o.innerHTML="",t?(a.textContent="STAGE CLEAR!",o.innerHTML=`<strong>${e}</strong><br>${s}`):a.textContent="GAME OVER",r.innerHTML="",t){const h=document.createElement("button");h.className="btn-toss btn-primary",h.innerHTML=`
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M5 12h14M12 5l7 7-7 7"/>
                </svg>
                Îã§Ïùå Ïä§ÌÖåÏù¥ÏßÄÎ°ú Ïù¥Îèô
            `,h.addEventListener("click",()=>{this.uiResultPopup.style.display="none",i&&i()}),r.appendChild(h)}else{const h=document.createElement("button");h.className="btn-toss btn-primary",h.innerHTML=`
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="5 3 19 12 5 21 5 3" />
                </svg>
                Í¥ëÍ≥†Î≥¥Í≥† Ïù¥Ïñ¥ÌïòÍ∏∞
            `,h.addEventListener("click",async()=>{await C(),this.revivePlayer()});const c=document.createElement("button");c.className="btn-toss btn-secondary",c.innerHTML=`
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 4v6h-6M1 20v-6h6" />
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
                </svg>
                Ï≤òÏùåÎ∂ÄÌÑ∞ Îã§ÏãúÌïòÍ∏∞
            `,c.addEventListener("click",()=>{this.uiResultPopup.style.display="none",this.isRunning=!0,this.isPaused=!1,this.lastTime=performance.now(),this.startStage(this.currentLevel),requestAnimationFrame(this.loop)}),r.appendChild(h),r.appendChild(c)}this.uiResultPopup.style.display="flex"}}console.log("üöÄ main.js loaded - Version 2025-12-09");async function F(){console.log("üéÆ Initializing game..."),await L(),new N,console.log("‚úÖ Game initialized successfully")}F();
